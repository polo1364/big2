<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>å¤§è€äºŒ â€” v24ï¼ˆå…§å»ºéŸ³æ•ˆï¼šç‰Œå‹å°ˆå±¬ï¼‰</title>
<style>
:root{
  --card-w:66px;--card-h:94px;--gap:8px;
  --pile-w:46px;--pile-h:63px;
  --panel-w:min(92vw,980px);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:radial-gradient(#162333,#0b121a);color:#e6eef6;font-family:"Microsoft JhengHei",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;user-select:none;overflow:hidden}
h1{margin:10px 0 6px;font-weight:800;letter-spacing:.5px;font-size:18px}
#stage{position:relative;width:100%;height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
.topbar{display:flex;justify-content:center;align-items:center;padding:6px 10px;gap:8px}
#resetScoreBtn{
  position:absolute;left:8px;top:8px;z-index:6;
  border:none;border-radius:12px;background:rgba(255,255,255,.06);color:#e6eef6;
  padding:10px 12px;min-height:40px;cursor:pointer;font-weight:700;
  border:1px solid rgba(255,255,255,.22)
}
#sfxToggle{
  position:absolute;right:8px;top:8px;z-index:6;
  border:none;border-radius:12px;background:rgba(255,255,255,.06);color:#e6eef6;
  padding:10px 12px;min-height:40px;cursor:pointer;font-weight:700;
  border:1px solid rgba(255,255,255,.22)
}
.table{position:relative;flex:1;display:grid;grid-template-columns:1fr auto 1fr;grid-template-rows:1fr auto 1fr;height:100%;gap:6px}
.player{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
.name{font-weight:800;letter-spacing:.5px}
.score{font-size:12px;opacity:.9;background:#0d2535;border:1px solid rgba(255,255,255,.16);padding:3px 8px;border-radius:999px}
.player:not(#p-bottom) .hand{display:none}
.hand{display:flex;gap:var(--gap);max-width:96vw;overflow-x:auto;padding:6px 4px;touch-action:pan-x;pointer-events:auto}
#hand-bottom.two-rows{flex-wrap:wrap;row-gap:10px;justify-content:center;overflow-x:hidden}
#hand-bottom.two-rows .card{ width:var(--card-w-2);height:calc(var(--card-w-2)*1.42);min-width:var(--card-w-2); }
.card{
  position:relative;
  width:var(--card-w);height:var(--card-h);min-width:var(--card-w);
  background:#fff;border-radius:14px;border:2px solid #cfd8dc;color:#0e141a;
  display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;
  transition:transform .18s, border-color .18s, box-shadow .18s;
  touch-action:manipulation;
}
.card::after{content:"";position:absolute;inset:-8px;border-radius:18px;pointer-events:none;}
.card.â™¥,.card.â™¦{color:#d11}
.selected{transform:translateY(-16px);border-color:#ffd866;box-shadow:0 10px 22px rgba(255,216,102,.35)}
#centerPanel{
  grid-column:2;grid-row:2;width:var(--panel-w);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;padding:12px 16px;backdrop-filter:blur(6px);
  display:flex;flex-direction:column;align-items:center;gap:8px;
  position:relative;overflow:visible;
}
#fx{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:5}
#info{font-size:15px;opacity:.95}
#last{font-size:13px;opacity:.8;min-height:18px}
#pile{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;position:relative;z-index:2}
.pile-card{width:var(--pile-w);height:var(--pile-h);background:#fff;border-radius:12px;border:2px solid #cfd8dc;display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:16px}
.pile-card.â™¥,.pile-card.â™¦{color:#d11}
#logCenter{
  width:100%;max-width:860px;height:120px;overflow-y:auto;border:1px dashed rgba(255,255,255,.18);border-radius:12px;
  padding:8px;background:rgba(0,0,0,.18);font-size:12px;display:flex;flex-direction:column;
}
.log-line{display:flex;align-items:center;gap:8px;margin:3px 0}
.log-who{opacity:.95;font-weight:800;min-width:60px;text-align:right}
.log-kind{opacity:.8}
.log-cards{display:flex;gap:4px;flex-wrap:wrap}
.log-card{width:30px;height:40px;background:#fff;border:2px solid #cfd8dc;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#0e141a}
.log-card.â™¥,.log-card.â™¦{color:#d11}
.actionRow{grid-column:2;display:flex;gap:12px;justify-content:center;margin-top:2px;flex-wrap:wrap}
button{
  font:inherit;font-weight:800;letter-spacing:.2px;
  padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.22);
  background:#24629b;color:#fff;cursor:pointer;min-width:112px;min-height:52px;font-size:16px
}
button[disabled]{opacity:.5;cursor:not-allowed}
.btn-ghost{background:rgba(255,255,255,.08);color:#e6eef6}
.btn-ghost:hover{background:rgba(255,255,255,.14)}
#p-top{grid-column:2;grid-row:1;justify-content:flex-end}
#p-left{grid-column:1;grid-row:2}
#p-right{grid-column:3;grid-row:2}
#p-bottom{grid-column:2;grid-row:3;justify-content:flex-start}

/* æç¤ºé¢æ¿ */
.overlay{ position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:40;padding:10px }
.panel{
  width:min(92vw,860px);max-height:80vh;overflow:auto;
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:16px
}
#hintPanel h2{margin:0 0 10px;font-size:20px}
#hintToolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
.chip{padding:8px 12px;border-radius:999px;background:#20303a;border:1px solid #3a5767;font-size:14px;cursor:pointer}
.chip.active{background:#3a5a70;border-color:#5d8ea8}
.section{margin:10px 0 8px}
.section h4{margin:6px 0 6px;font-size:14px;opacity:.9}
.combo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px}
.combo-row{
  display:flex;align-items:center;gap:6px;padding:8px;border-radius:12px;background:#1a2833;border:1px solid #2e4453;cursor:pointer
}
.combo-row:hover{background:#213443}
.mini{width:34px;height:48px;background:#fff;border:2px solid #cfd8dc;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#0e141a}
.mini.â™¥,.mini.â™¦{color:#d11}
.tag{margin-left:auto;font-size:12px;opacity:.75}

/* çµç®— */
.panel h2{margin:0 0 10px;font-size:20px}
.pList{list-style:none;margin:0;padding:0}
.pItem{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);margin-bottom:8px}
.pName{font-weight:800}
.pExplain{opacity:.85;font-size:12px}
.pRight{display:flex;gap:12px;align-items:center}
.pDelta.plus{color:#7fe57f}
.pDelta.minus{color:#ff9580}
.pScore{font-weight:800}
.rank{list-style:none;margin:8px 0 0;padding:0}
.rank li{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:10px;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.12);margin-bottom:8px}

/* FX */
@keyframes fx-pop{0%{transform:scale(.6);opacity:0}70%{transform:scale(1.1);opacity:1}100%{transform:scale(1);opacity:1}}
.fx-symbol{
  position:absolute;left:50%;top:22%;transform:translate(-50%,-50%);font-weight:900;
  font-size:72px;line-height:1;border-radius:16px;padding:10px 16px;
  background:radial-gradient(circle at 40% 40%, rgba(255,255,255,.95), rgba(255,255,255,.75));
  color:#111;border:3px solid rgba(0,0,0,.2);box-shadow:0 10px 30px rgba(0,0,0,.35);
  animation:fx-pop .45s ease-out both;z-index:6
}
.highlight-pile .pile-card{box-shadow:0 0 0 3px #ffd54a, 0 8px 30px rgba(255,213,74,.45);transform:translateY(-2px)}
@keyframes fx-ring{0%{transform:translate(-50%,-50%) scale(.4);opacity:.9}100%{transform:translate(-50%,-50%) scale(2.2);opacity:0}}
.fx-ring{position:absolute;left:50%;top:30%;width:220px;height:220px;border:4px solid rgba(255,255,255,.8);border-radius:50%;filter:blur(.4px);animation:fx-ring .9s ease-out forwards;z-index:4}
@keyframes fx-confetti{
  0%{transform:translate(var(--x,0),var(--y,0)) rotate(0deg);opacity:1}
  100%{transform:translate(calc(var(--x,0) + var(--dx,0px)), calc(var(--y,0) + 120px)) rotate(360deg);opacity:0}
}
.fx-confetti{position:absolute;width:10px;height:14px;border-radius:2px;animation:fx-confetti .8s linear forwards;opacity:.95;z-index:5}
@keyframes fx-shake{10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(4px)}30%,50%,70%{transform:translateX(-8px)}40%,60%{transform:translateX(8px)}}
.shake{animation:fx-shake .5s ease-in-out 1}
@keyframes fx-flash{0%{opacity:.9}100%{opacity:0}}
.fx-flash{position:absolute;inset:0;background:rgba(255,255,255,.9);animation:fx-flash .18s ease-out forwards;z-index:7}
.fx-bolt{
  position:absolute;width:4px;height:180px;border-radius:2px;
  background:linear-gradient(#fff,#e3f2fd,#90caf9,#42a5f5,#0d47a1);
  box-shadow:0 0 12px #90caf9, 0 0 24px #42a5f5;
  transform-origin:top; z-index:6; opacity:.95;
  animation:fx-pop .2s ease-out both;
}
@keyframes fx-roll{0%{transform:translateX(-60%) rotate(0)}100%{transform:translateX(160%) rotate(720deg)}}
.fx-roll{
  position:absolute;left:0;right:0;top:10%;margin:auto;width:max-content;
  font-weight:900;font-size:48px;letter-spacing:.4em;
  background:linear-gradient(90deg,#ffe082,#fff176,#ffd54f);
  color:#4e342e;border:3px solid rgba(78,52,46,.25);border-radius:999px;padding:6px 16px;
  box-shadow:0 8px 24px rgba(255,213,74,.35); z-index:6;
  animation:fx-roll .9s ease-in-out forwards;
}
</style>
</head>
<body>
<div id="stage">
  <div class="topbar"><h1>å¤§è€äºŒ</h1></div>
  <div class="table">
    <button id="resetScoreBtn">é‡ç½®åˆ†æ•¸(10000)</button>
    <button id="sfxToggle">éŸ³æ•ˆï¼šé–‹</button>
    <div id="p-top" class="player"><div class="name" id="name-top"></div><div class="score" id="score-top">10000 åˆ†</div><div class="hand" id="hand-top"></div><div class="count" id="cnt-top"></div></div>
    <div id="p-left" class="player"><div class="name" id="name-left"></div><div class="score" id="score-left">10000 åˆ†</div><div class="hand" id="hand-left"></div><div class="count" id="cnt-left"></div></div>
    <div id="centerPanel">
      <div id="fx"></div>
      <div id="info">è¼‰å…¥ä¸­â€¦</div>
      <div id="last"></div>
      <div id="pile"></div>
      <div id="logCenter"></div>
      <div class="actionRow">
        <button id="playBtn" disabled>å‡ºç‰Œ</button>
        <button id="passBtn" disabled>PASS</button>
        <button class="btn-ghost" id="hintBtn">æç¤º</button>
        <button class="btn-ghost" id="dealBtn">é‡ç™¼</button>
      </div>
    </div>
    <div id="p-right" class="player"><div class="name" id="name-right"></div><div class="score" id="score-right">10000 åˆ†</div><div class="hand" id="hand-right"></div><div class="count" id="cnt-right"></div></div>
    <div id="p-bottom" class="player">
      <div class="name" id="name-bottom">ä½ </div>
      <div class="score" id="score-bottom">10000 åˆ†</div>
      <div class="hand" id="hand-bottom"></div>
      <div class="count" id="cnt-bottom"></div>
    </div>
  </div>
</div>

<!-- æç¤ºé¢æ¿ -->
<div id="hintOverlay" class="overlay">
  <div id="hintPanel" class="panel">
    <h2>å¯å‡ºçµ„åˆ</h2>
    <div id="hintToolbar"></div>
    <div id="hintSections"></div>
  </div>
</div>

<!-- å–®å±€çµç®—ï¼ˆåƒ…ä¿ç•™ã€Œç¹¼çºŒã€ï¼‰ -->
<div id="roundOverlay" class="overlay">
  <div class="panel">
    <h2 id="roundTitle">æœ¬å±€çµç®—</h2>
    <ul id="roundList" class="pList"></ul>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:6px">
      <button id="roundContinueBtn">ç¹¼çºŒä¸‹ä¸€å±€</button>
    </div>
  </div>
</div>

<!-- ç³»åˆ—æˆ°çµç®— -->
<div id="seriesOverlay" class="overlay">
  <div class="panel">
    <h2>ç³»åˆ—æˆ°çµç®—ï¼ˆæœ‰äººåˆ†æ•¸æ­¸é›¶ï¼‰</h2>
    <ul id="rankList" class="rank"></ul>
    <div style="display:flex;gap:10px;justify-content:center">
      <button id="restartSeriesBtn">é‡æ–°é–‹æ–°ç³»åˆ—ï¼ˆåˆ†æ•¸é‡ç½® 10000ï¼‰</button>
      <button class="btn-ghost" id="closeSeriesBtn">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
"use strict";
/* ====== éŸ³æ•ˆç³»çµ±ï¼ˆWebAudioï¼Œç„¡éœ€å¤–éƒ¨æª”æ¡ˆï¼‰ ====== */
const SFX = (()=>{
  let enabled = true;
  let ctx, master;
  function ensure(){
    if(ctx) return;
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain(); master.gain.value = 0.4; master.connect(ctx.destination);
  }
  function click(){ if(!enabled) return; ensure();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='square'; o.frequency.value=900; g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.08);
    o.connect(g); g.connect(master); o.start(); o.stop(ctx.currentTime+0.09);
  }
  function tone(freq=440, dur=0.18, type='sine', vol=0.35){ if(!enabled) return; ensure();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(vol, ctx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g); g.connect(master); o.start(); o.stop(ctx.currentTime+dur+0.02);
  }
  function sweep(start=300,end=900,dur=0.4,type='sawtooth',vol=0.25){ if(!enabled) return; ensure();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.setValueAtTime(start, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(end, ctx.currentTime+dur);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.linearRampToValueAtTime(vol, ctx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o.connect(g); g.connect(master); o.start(); o.stop(ctx.currentTime+dur+0.02);
  }
  function noise(dur=0.2, vol=0.25){ if(!enabled) return; ensure();
    const buffer = ctx.createBuffer(1, ctx.sampleRate*dur, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1)*Math.pow(1-i/data.length, .5); }
    const n = ctx.createBufferSource(); n.buffer = buffer;
    const g = ctx.createGain(); g.gain.value = vol;
    n.connect(g); g.connect(master); n.start(); n.stop(ctx.currentTime+dur);
  }
  function thump(){ if(!enabled) return; ensure(); noise(0.07, 0.35); tone(160, 0.12, 'sine', 0.2); }
  function pair(){ tone(520,0.12,'triangle'); setTimeout(()=>tone(660,0.12,'triangle'), 120); }
  function trips(){ tone(500,0.1,'sine'); setTimeout(()=>tone(640,0.1,'sine'),100); setTimeout(()=>tone(780,0.12,'sine'),200); }
  function straight(){ const seq=[440,494,554,622,740]; seq.forEach((f,i)=>setTimeout(()=>tone(f,0.09,'square',0.22), i*80)); }
  function fullhouse(){ thump(); setTimeout(()=>pair(),120); }
  function fourKind(){ sweep(900,200,0.35,'sawtooth',0.28); setTimeout(()=>noise(0.08,0.35), 260); }
  function straightFlush(){ tone(660,0.14,'triangle',0.28); setTimeout(()=>tone(880,0.16,'triangle',0.28),160); setTimeout(()=>tone(1175,0.2,'triangle',0.28),320); }
  function spade2(){ sweep(300,1200,0.35,'square',0.32); }
  function playFor(kind, includesSpade2){
    if(includesSpade2) spade2();
    switch(kind){
      case 'å–®å¼µ': click(); break;
      case 'å°å­': pair(); break;
      case 'ä¸‰æ¢': trips(); break;
      case 'é †å­': straight(); break;
      case 'è‘«è˜†': fullhouse(); break;
      case 'éµæ”¯': fourKind(); break;
      case 'åŒèŠ±é †': straightFlush(); break;
    }
  }
  function toggle(){ enabled=!enabled; return enabled; }
  function set(v){ enabled=!!v; }
  return {click, playFor, toggle, set};
})();

/* ====== åŸºæœ¬è³‡æ–™ ====== */
const SUITS=['â™£','â™¦','â™¥','â™ '],RANKS=['3','4','5','6','7','8','9','10','J','Q','K','A','2'];
const suitOrder={'â™£':0,'â™¦':1,'â™¥':2,'â™ ':3};
const rIdx=r=>RANKS.indexOf(r);
const compareCard=(a,b)=>(rIdx(a.rank)-rIdx(b.rank))||(suitOrder[a.suit]-suitOrder[b.suit]);
let deck=[],players=[[],[],[],[]],turn=0,currentPlay=null,lastWinner=-1,firstTrick=true,names=[],scores=[10000,10000,10000,10000];
let pendingDeal=false;

const $ = s => document.querySelector(s);
const logBox = $('#logCenter');
const info = t => $('#info').innerText=t;
const setLast = t => $('#last').innerText=t||'';

/* éŸ³æ•ˆé–‹é—œ */
(function initSFXToggle(){
  const btn = document.getElementById('sfxToggle');
  let saved = localStorage.getItem('big2_sfx');
  if(saved!==null){ SFX.set(saved==='1'); btn.textContent = `éŸ³æ•ˆï¼š${saved==='1'?'é–‹':'é—œ'}`; }
  btn.addEventListener('click', ()=>{
    const on = SFX.toggle();
    btn.textContent = `éŸ³æ•ˆï¼š${on?'é–‹':'é—œ'}`;
    try{ localStorage.setItem('big2_sfx', on?'1':'0'); }catch(e){}
  });
})();

/* ç´€éŒ„ */
function logAppendPlay(who,cards,kind){
  const line = document.createElement('div'); line.className='log-line';
  const ww = document.createElement('div'); ww.className='log-who'; ww.textContent=who;
  const kk = document.createElement('div'); kk.className='log-kind'; kk.textContent='ï¼ˆ'+kind+'ï¼‰';
  const cc = document.createElement('div'); cc.className='log-cards';
  cards.forEach(c=>{ const d=document.createElement('div'); d.className='log-card '+c.suit; d.textContent=c.suit+c.rank; cc.appendChild(d); });
  line.appendChild(ww); line.appendChild(kk); line.appendChild(cc);
  logBox.appendChild(line); logBox.scrollTop = logBox.scrollHeight;
}
function logAppendText(t){
  const line = document.createElement('div'); line.className='log-line';
  const ww = document.createElement('div'); ww.className='log-who'; ww.textContent='';
  const kk = document.createElement('div'); kk.className='log-kind'; kk.textContent=t;
  line.appendChild(ww); line.appendChild(kk); logBox.appendChild(line); logBox.scrollTop = logBox.scrollHeight;
}

/* åå­— */
function randName(){const a="ç‹æå¼µé™³æ—å³é»ƒè”¡æ¥Šè¨±é„­ä½•éƒ­ç¾…é«˜èƒ¡è•­æ½˜æ±Ÿé¾æ›¾è³´å‘‚å­«é­è‘‰é˜®é‚±å½­é¡è¬å®‹å”é¦®é‚µéŸ“æ›¹é‚¢é¡§";
const b="å‡±å®‡å®¶è±ªå¿—å‰å† å»·å»ºå®å¿—è±ªä¿Šå‚‘æ˜å“²å† éœ–ä¿Šå®‡æ‰¿ç¿°æŸå®‡å®—æ†²æ€¡å›æ¬£æ€¡é›…å©·é›…é›¯ä½³è“‰ä½©çŠæƒ é›¯å¿—ç²ç¾ç²";
return a[Math.floor(Math.random()*a.length)]+b[Math.floor(Math.random()*a.length)] + (Math.random()<.45?b[Math.floor(Math.random()*a.length)]:'');}

/* åˆ†æ•¸ */
function saveScores(){ try{ localStorage.setItem('big2_scores', JSON.stringify(scores)); }catch(e){} }
function loadScores(){
  try{ const s = JSON.parse(localStorage.getItem('big2_scores')); if(Array.isArray(s) && s.length===4) scores = s; }catch(e){}
  updateScoreUI();
}
function updateScoreUI(){ ['bottom','right','top','left'].forEach((pos,i)=>{ $('#score-'+pos).innerText = (scores[i]||0)+' åˆ†'; }); }

/* ç‰Œçµ„èˆ‡ UI */
function buildDeck(){ deck=[]; for(const s of SUITS) for(const r of RANKS) deck.push({suit:s,rank:r}); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function findStart(){ for(let i=0;i<4;i++) if(players[i].some(c=>c.rank==='3'&&c.suit==='â™£')) return i; return 0; }
function render(){
  const ids=['hand-bottom','hand-right','hand-top','hand-left'];
  ids.forEach((id,i)=>{
    const area = document.getElementById(id); area.innerHTML='';
    players[i].forEach((c,idx)=>{
      if(i===0){
        const d=document.createElement('div');
        d.className=`card ${c.suit}`; d.textContent=c.suit+c.rank; d.dataset.idx=idx;
        d.addEventListener('click', ()=>{ if(turn!==0) return; d.classList.toggle('selected'); SFX.click(); }, {passive:true});
        let sx=0,sy=0;
        d.addEventListener('touchstart', e=>{ if(turn!==0) return; const t=e.changedTouches[0]; sx=t.clientX; sy=t.clientY; }, {passive:true});
        d.addEventListener('touchend', e=>{
          if(turn!==0) return;
          const t=e.changedTouches[0];
          if(Math.hypot(t.clientX-sx, t.clientY-sy) < 10){ e.preventDefault(); d.classList.toggle('selected'); SFX.click(); }
        }, {passive:false});
        area.appendChild(d);
      }
    });
  });
  ['bottom','right','top','left'].forEach((pos,i)=>$('#cnt-'+pos).innerText=players[i].length);
  adjustTwoRows();
}
function updateTurnUI(){
  const mine = (turn===0);
  const canPass = mine && !!currentPlay;
  $('#playBtn').disabled = !mine;
  $('#passBtn').disabled = !canPass;
  info(mine ? (firstTrick? 'è¼ªåˆ°ä½ ï¼ˆé¦–æ”»éœ€å« â™£3ï¼›é¦–æ”»ä¸å¯ PASSï¼‰' : (currentPlay?'è¼ªåˆ°ä½ ï¼ˆå¯è·Ÿç‰Œæˆ– PASSï¼‰':'ä½ æ‹¿åˆ°å‡ºç‰Œæ¬Šï¼ˆä¸å¯ PASSï¼‰')) : `ç­‰å¾… ${names[turn]} å‡ºç‰Œâ€¦`);
}

/* å…©æ’æ‰‹ç‰Œ */
function isPortrait(){ return window.innerHeight > window.innerWidth; }
function adjustTwoRows(){
  const hand = document.getElementById('hand-bottom');
  hand.classList.remove('two-rows');
  if(!isPortrait()) return;
  const n = players[0].length;
  if(n<=7) return;
  const avail = Math.floor(window.innerWidth * 0.94);
  const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 8;
  const cardW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-w')) || 66;
  const oneRowWidth = n*cardW + (n-1)*gap;
  if(oneRowWidth <= avail) return;
  const cols = Math.ceil(n/2);
  const w2 = Math.max(54, Math.min(84, Math.floor((avail - (cols-1)*gap)/cols)));
  hand.style.setProperty('--card-w-2', w2 + 'px');
  hand.classList.add('two-rows');
}
window.addEventListener('resize', adjustTwoRows);

/* è¦å‰‡ï¼šéµæ”¯=å››æ¢ï¼‹å–®å¼µï¼ˆ5å¼µï¼‰ */
function isConsec(s){ for(let i=1;i<s.length;i++) if(rIdx(s[i].rank)!==rIdx(s[i-1].rank)+1) return false; return true; }
function analyze(cs){
  const n=cs.length, s=[...cs].sort(compareCard);
  if(n===1) return {ok:true,kind:'å–®å¼µ',high:s[0]};
  if(n===2 && s[0].rank===s[1].rank) return {ok:true,kind:'å°å­',high:s[1]};
  if(n===3 && s.every(c=>c.rank===s[0].rank)) return {ok:true,kind:'ä¸‰æ¢',high:s[2]};
  if(n===4){ return {ok:false}; }
  if(n===5){
    const rc={}; s.forEach(c=>rc[c.rank]=(rc[c.rank]||0)+1);
    const vals=Object.values(rc).sort((a,b)=>b-a);
    const keys=Object.keys(rc);
    const sameSuit=s.every(c=>c.suit===s[0].suit);
    const consec=isConsec(s);
    if(sameSuit&&consec) return {ok:true,kind:'åŒèŠ±é †',high:s[4]};
    if(vals[0]===4 && vals[1]===1){
      const quadRank = keys.find(r=>rc[r]===4);
      const high = s.filter(c=>c.rank===quadRank).slice(-1)[0];
      return {ok:true,kind:'éµæ”¯',high};
    }
    if(vals[0]===3&&vals[1]===2){
      const trip=keys.find(r=>rc[r]===3);
      const high=s.filter(c=>c.rank===trip).slice(-1)[0];
      return {ok:true,kind:'è‘«è˜†',high};
    }
    if(consec) return {ok:true,kind:'é †å­',high:s[4]};
  }
  return {ok:false};
}
const strength={'å–®å¼µ':1,'å°å­':2,'ä¸‰æ¢':3,'é †å­':4,'è‘«è˜†':5,'éµæ”¯':6,'åŒèŠ±é †':7};
function canBeat(a,b){
  if(!b) return true;
  const A=analyze(a), B=analyze(b);
  if(!A.ok || !B.ok) return false;
  if(A.kind===B.kind){
    const r=rIdx(A.high.rank)-rIdx(B.high.rank);
    if(r!==0) return r>0;
    return suitOrder[A.high.suit]>suitOrder[B.high.suit];
  }
  if(A.kind==='éµæ”¯' && (B.kind==='è‘«è˜†'||B.kind==='é †å­'||B.kind==='å°å­')) return true;
  if(A.kind==='åŒèŠ±é †' && (B.kind==='éµæ”¯'||B.kind==='è‘«è˜†'||B.kind==='é †å­'||B.kind==='å°å­')) return true;
  return false;
}

/* åˆ—èˆ‰ï¼ˆå«éµæ”¯ 4+1ï¼‰ */
function combos(hand){
  const res=[],map={};
  hand.forEach(c=>(map[c.rank]=map[c.rank]||[]).push(c));
  hand.forEach(c=>res.push([c]));
  for(const r in map){
    const a=map[r];
    if(a.length>=2) for(let i=0;i<a.length;i++) for(let j=i+1;j<a.length;j++) res.push([a[i],a[j]]);
    if(a.length>=3) for(let i=0;i<a.length;i++) for(let j=i+1;j<a.length;j++) for(let k=j+1;k<a.length;k++) res.push([a[i],a[j],a[k]]);
  }
  // æš´åŠ›åˆ—èˆ‰æ‰€æœ‰äº”å¼µçµ„åˆ
  const N=hand.length;
  for(let a=0;a<N-4;a++) for(let b=a+1;b<N-3;b++) for(let c=b+1;c<N-2;c++) for(let d=c+1;d<N-1;d++) for(let e=d+1;e<N;e++){
    const pack=[hand[a],hand[b],hand[c],hand[d],hand[e]];
    const an=analyze(pack);
    if(an.ok) res.push(pack);
  }
  res.sort((x,y)=>{
    const A=analyze(x),B=analyze(y);
    if(strength[A.kind]!==strength[B.kind]) return strength[A.kind]-strength[B.kind];
    const r=rIdx(A.high.rank)-rIdx(B.high.rank);
    return r!==0?r:(suitOrder[A.high.suit]-suitOrder[B.high.suit]);
  });
  return res;
}

/* ===== FX ===== */
const fxLayer = document.getElementById('fx');
function clearFX(){ fxLayer.innerHTML=''; document.getElementById('centerPanel').classList.remove('shake','highlight-pile'); }
function spawnSymbol(text){
  const el=document.createElement('div'); el.className='fx-symbol'; el.textContent=text;
  fxLayer.appendChild(el); setTimeout(()=>el.remove(), 900);
}
function spawnRing(){ const r=document.createElement('div'); r.className='fx-ring'; fxLayer.appendChild(r); setTimeout(()=>r.remove(), 900); }
function spawnConfetti(colors= ['#000','#ffd54a','#e53935','#1e88e5'], n=26){
  const rect = document.getElementById('pile').getBoundingClientRect();
  const host = document.getElementById('centerPanel').getBoundingClientRect();
  for(let i=0;i<n;i++){
    const c=document.createElement('div'); c.className='fx-confetti';
    c.style.background = colors[i%colors.length];
    const startX = (rect.left+rect.width/2) - host.left + (Math.random()*40-20);
    const startY = (rect.top+rect.height/2) - host.top + (Math.random()*10-5);
    const dx = (Math.random()*280-140)+'px';
    c.style.setProperty('--x', startX+'px');
    c.style.setProperty('--y', startY+'px');
    c.style.setProperty('--dx', dx);
    c.style.left='0'; c.style.top='0';
    fxLayer.appendChild(c);
    setTimeout(()=>c.remove(), 900);
  }
}
function spawnFlash(){ const f=document.createElement('div'); f.className='fx-flash'; fxLayer.appendChild(f); setTimeout(()=>f.remove(),180); }
function spawnBolt(){
  const host = document.getElementById('centerPanel').getBoundingClientRect();
  for(let i=0;i<3;i++){
    const b=document.createElement('div'); b.className='fx-bolt';
    const x = Math.random()*host.width*0.7 + host.width*0.15;
    const rotate = (Math.random()*40-20);
    b.style.left = x+'px'; b.style.top='-10px'; b.style.transform = `rotate(${rotate}deg)`;
    fxLayer.appendChild(b);
    setTimeout(()=>b.remove(), 500);
  }
}
function spawnRoll(){
  const r=document.createElement('div'); r.className='fx-roll'; r.textContent='è‘«è˜†';
  fxLayer.appendChild(r); setTimeout(()=>r.remove(), 900);
}
function triggerFX(kind, cards){
  clearFX();
  const includesSpade2 = cards.some(c=>c.rank==='2'&&c.suit==='â™ ');
  const isFour = (kind==='éµæ”¯');
  const isSF = (kind==='åŒèŠ±é †');
  const isFull = (kind==='è‘«è˜†');
  if(includesSpade2 || isSF || isFour || isFull){
    document.getElementById('centerPanel').classList.add('highlight-pile');
  }
  if(includesSpade2){ spawnSymbol('â™ 2'); spawnRing(); spawnConfetti(['#000','#ffd54a','#fff'], 34); document.getElementById('centerPanel').classList.add('shake'); }
  if(isSF){ spawnSymbol('åŒèŠ±é †'); spawnRing(); spawnConfetti(['#e53935','#ffca28','#43a047','#1e88e5','#8e24aa'], 42); document.getElementById('centerPanel').classList.add('shake'); }
  if(isFour){ spawnFlash(); spawnBolt(); spawnBolt(); spawnSymbol('éµæ”¯'); document.getElementById('centerPanel').classList.add('shake'); }
  if(isFull){ spawnRoll(); spawnSymbol('è‘«è˜†'); }
  // æ’­æ”¾å°æ‡‰éŸ³æ•ˆ
  SFX.playFor(kind, includesSpade2);
}

/* AIï¼ˆç•¥åŒå‰ï¼‰ */
function pickLeaderCombo(all, enemyAlmostWin){
  const prefer = enemyAlmostWin ? ['åŒèŠ±é †','éµæ”¯','è‘«è˜†','é †å­','ä¸‰æ¢','å°å­','å–®å¼µ']
                                : ['é †å­','è‘«è˜†','ä¸‰æ¢','å°å­','å–®å¼µ'];
  for(const k of prefer){
    const cands = all.filter(c=>analyze(c).kind===k);
    if(cands.length) return cands[0];
  }
  return all[0]||null;
}
function pickResponseCombo(options, currentPlay){
  const needKind = analyze(currentPlay).kind;
  const same = options.filter(c=>analyze(c).kind===needKind);
  if(same.length) return same[0];
  const bombs = options.filter(c=>['éµæ”¯','åŒèŠ±é †'].includes(analyze(c).kind));
  if(bombs.length) return bombs[0];
  return options[0]||null;
}
function aiPlay(){
  const i=turn, hand=players[i];
  const isLeader = !currentPlay || turn===lastWinner;
  const all=combos(hand);
  const enemyAlmostWin = players.some((p,idx)=>idx!==i && p.length<=2);
  let options=[];
  if(!currentPlay){
    options = firstTrick ? all.filter(c=>c.some(x=>x.rank==='3'&&x.suit==='â™£')) : all;
    const choice = pickLeaderCombo(options, enemyAlmostWin);
    if(choice) play(i,choice); else { info(`${names[i]} PASS`); logAppendText(`${names[i]} PASS`); next(); }
    return;
  }else{
    options = all.filter(c=>canBeat(c,currentPlay));
    if(options.length){
      const choice = pickResponseCombo(options, currentPlay);
      play(i,choice); return;
    }
    if(isLeader){
      const nonSingles = all.filter(c=>analyze(c).kind!=='å–®å¼µ');
      play(i, (nonSingles[0]||all[0]) );
    }else{
      info(`${names[i]} PASS`); logAppendText(`${names[i]} PASS`); next();
    }
  }
}

/* å‡ºç‰Œèˆ‡å›åˆ */
function toStr(cards){ return cards.map(c=>c.suit+c.rank).join(' '); }
function renderPile(playerName,cards,kind){
  const pile=$('#pile'); pile.innerHTML='';
  const head=document.createElement('div'); head.style.fontSize='12px'; head.style.opacity=.9; head.textContent = `${playerName}ï¼ˆ${kind}ï¼‰`;
  pile.appendChild(head);
  const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.flexWrap='wrap'; row.style.justifyContent='center';
  cards.forEach(c=>{ const d=document.createElement('div'); d.className='pile-card '+c.suit; d.textContent=c.suit+c.rank; row.appendChild(d); });
  pile.appendChild(row);
}
function play(i,cards){
  cards.forEach(sel=>{
    const idx=players[i].findIndex(p=>p.rank===sel.rank&&p.suit===sel.suit);
    if(idx>-1) players[i].splice(idx,1);
  });
  render();
  const an=analyze(cards);
  currentPlay=cards; lastWinner=i; firstTrick=false;
  setLast(`${names[i]}ï¼š${toStr(cards)}ï¼ˆ${an.kind}ï¼‰`);
  logAppendPlay(names[i],cards,an.kind);
  renderPile(names[i],cards,an.kind);
  triggerFX(an.kind, cards);
  if(players[i].length===0){ endRound(i); return; }
  next();
}
function next(){
  turn=(turn+1)%4;
  if(players[turn].length===0) turn=(turn+1)%4;
  if(turn===lastWinner){ currentPlay=null; setLast(`${names[turn]} é‡æ–°å‡ºç‰Œ`); $('#pile').innerHTML=''; clearFX(); }
  updateTurnUI();
  if(turn!==0) setTimeout(aiPlay,600);
}
function selected(){ return [...document.querySelectorAll('#hand-bottom .card.selected')].map(el=>players[0][parseInt(el.dataset.idx,10)]); }
function onPlay(){
  if(turn!==0) return;
  const cs=selected();
  if(!cs.length){ info('è«‹å…ˆé¸ç‰Œ'); return; }
  const an=analyze(cs);
  if(!an.ok){ info('ä¸åˆæ³•çµ„åˆ'); return; }
  if(firstTrick && !cs.some(c=>c.rank==='3'&&c.suit==='â™£')){ info('é¦–æ”»å¿…å« â™£3'); return; }
  if(currentPlay && !canBeat(cs,currentPlay)){ info('æ¯”ä¸éå‰å®¶'); return; }
  play(0,cs);
}
function onPass(){
  if(turn!==0) return;
  if(!currentPlay){ info('é¦–æ”»ä¸å¯ PASS'); return; }
  info('ä½  PASS'); logAppendText('ä½  PASS'); next();
}

/* è¨ˆåˆ†èˆ‡çµç®— */
function hasFourOfKind(hand){ const rc={}; hand.forEach(c=>rc[c.rank]=(rc[c.rank]||0)+1); return Object.values(rc).some(v=>v===4); }
function hasStraightFlush(hand){
  const bySuit={'â™£':[], 'â™¦':[], 'â™¥':[], 'â™ ':[]};
  hand.forEach(c=>bySuit[c.suit].push(c));
  for(const s in bySuit){
    const arr=bySuit[s].sort(compareCard);
    for(let i=0;i<=arr.length-5;i++){
      const slice=arr.slice(i,i+5);
      if(slice.length===5 && slice.every((c,idx)=>idx===0 || rIdx(c.rank)===rIdx(slice[idx-1].rank)+1)) return true;
    }
  }
  return false;
}
function endRound(winnerIdx){
  const per=[]; let totalGain=0;
  for(let i=0;i<4;i++){
    if(i===winnerIdx) continue;
    const remain=players[i];
    let base = remain.length*10;
    let factor = 1;
    const why=[];
    why.push(`å‰© ${remain.length} å¼µ Ã—10 = ${base}`);
    if(remain.length>=8){ factor*=2; why.push('â‰¥8 å¼µ Ã—2'); }
    if(remain.some(c=>c.rank==='2')){ factor*=2; why.push('å« 2 Ã—2'); }
    if(hasFourOfKind(remain)){ factor*=2; why.push('éµæ”¯ Ã—2'); }
    if(hasStraightFlush(remain)){ factor*=2; why.push('åŒèŠ±é † Ã—2'); }
    const pen = base*factor;
    scores[i]-=pen; totalGain+=pen;
    per.push({i,name:names[i],delta:-pen,explain:why.join('ã€'),after:scores[i]});
  }
  scores[winnerIdx]+=totalGain;
  per.push({i:winnerIdx,name:names[winnerIdx],delta:+totalGain,explain:`è´èµ°å…¶ä»–ç©å®¶æ‡²ç½°ç¸½å’Œ +${totalGain}`,after:scores[winnerIdx]});
  updateScoreUI(); saveScores();

  showRound(per, winnerIdx);
  const zeroIdx = scores.findIndex(s=>s<=0);
  if(zeroIdx!==-1){ showSeries(); }
}

function showRound(per, winnerIdx){
  const list = $('#roundList'); list.innerHTML='';
  $('#roundTitle').innerText = `æœ¬å±€çµç®—ï¼š${names[winnerIdx]} è„«æ‰‹`;
  per.sort((a,b)=>a.i-b.i).forEach(row=>{
    const li=document.createElement('li'); li.className='pItem';
    const left=document.createElement('div');
    left.innerHTML = `<div class="pName">${row.name}</div><div class="pExplain">${row.explain}</div>`;
    const right=document.createElement('div'); right.className='pRight';
    const delta=document.createElement('div'); delta.className='pDelta '+(row.delta>=0?'plus':'minus'); delta.textContent = (row.delta>=0?'+':'')+row.delta;
    const after=document.createElement('div'); after.className='pScore'; after.textContent = row.after+' åˆ†';
    right.appendChild(delta); right.appendChild(after);
    li.appendChild(left); li.appendChild(right); list.appendChild(li);
  });
  document.getElementById('roundOverlay').style.display='flex';
  pendingDeal=true;
}
function showSeries(){
  const rank = scores.map((s,i)=>({i, name:names[i], score:s})).sort((a,b)=>b.score-a.score);
  const ul = $('#rankList'); ul.innerHTML='';
  rank.forEach((r,idx)=>{
    const li=document.createElement('li'); li.innerHTML = `<div>${idx+1}. ${r.name}</div><div>${r.score} åˆ†</div>`; ul.appendChild(li);
  });
  document.getElementById('seriesOverlay').style.display='flex';
}

document.getElementById('roundContinueBtn').onclick=()=>{
  document.getElementById('roundOverlay').style.display='none';
  if(pendingDeal){ pendingDeal=false; deal(); }
};
document.getElementById('restartSeriesBtn').onclick=()=>{
  scores=[10000,10000,10000,10000]; saveScores(); updateScoreUI();
  document.getElementById('seriesOverlay').style.display='none';
};
document.getElementById('closeSeriesBtn').onclick=()=>{ document.getElementById('seriesOverlay').style.display='none'; };

/* ====== æç¤ºï¼ˆæ˜“è®€ç‰ˆï¼‰ ====== */
const HINT_TYPES=['å–®å¼µ','å°å­','ä¸‰æ¢','é †å­','è‘«è˜†','éµæ”¯','åŒèŠ±é †'];
const hintOverlay=$('#hintOverlay'), hintToolbar=$('#hintToolbar'), hintSections=$('#hintSections');
let hintOnlyBeat=true, hintNeedType=null;
function openHints(){
  hintNeedType = currentPlay ? analyze(currentPlay).kind : null;
  hintOnlyBeat = !!currentPlay;
  renderHint();
  hintOverlay.style.display='flex';
}
function closeHints(){ hintOverlay.style.display='none'; }
hintOverlay.addEventListener('click', e=>{ if(e.target===hintOverlay) closeHints(); });

function makeChip(text, active, onClick){
  const c=document.createElement('div'); c.className='chip'+(active?' active':''); c.textContent=text; c.onclick=onClick; return c;
}
function renderHint(){
  hintToolbar.innerHTML=''; hintSections.innerHTML='';
  hintToolbar.appendChild(makeChip(hintOnlyBeat?'åªçœ‹å¯å£“éï¼ˆé–‹ï¼‰':'åªçœ‹å¯å£“éï¼ˆé—œï¼‰', hintOnlyBeat, ()=>{ hintOnlyBeat=!hintOnlyBeat; renderHint(); }));
  HINT_TYPES.forEach(t=>{
    hintToolbar.appendChild(makeChip(t+(hintNeedType===t?' âœ“':''), hintNeedType===t, ()=>{ hintNeedType = (hintNeedType===t? null : t); renderHint(); }));
  });
  let arr = combos(players[0]);
  if(firstTrick) arr = arr.filter(c=>c.some(x=>x.rank==='3'&&x.suit==='â™£'));
  if(hintOnlyBeat && currentPlay) arr = arr.filter(c=>canBeat(c,currentPlay));
  if(hintNeedType) arr = arr.filter(c=>analyze(c).kind===hintNeedType);
  if(arr.length===0){ hintSections.textContent='ï¼ˆç›®å‰æ²’æœ‰å¯å‡ºçš„çµ„åˆï¼‰'; return; }
  const groups={}; arr.forEach(c=>{ const k=analyze(c).kind; (groups[k]=groups[k]||[]).push(c); });
  HINT_TYPES.forEach(k=>{
    if(!groups[k]||groups[k].length===0) return;
    const sec=document.createElement('div'); sec.className='section';
    const h4=document.createElement('h4'); h4.textContent=`${k}ï¼ˆ${groups[k].length}ï¼‰`; sec.appendChild(h4);
    const grid=document.createElement('div'); grid.className='combo-grid';
    groups[k].forEach(c=>{
      const row=document.createElement('div'); row.className='combo-row';
      c.forEach(card=>{ const m=document.createElement('div'); m.className='mini '+card.suit; m.textContent=card.suit+card.rank; row.appendChild(m); });
      const tag=document.createElement('div'); tag.className='tag'; tag.textContent=k; row.appendChild(tag);
      row.onclick=()=>{
        document.querySelectorAll('#hand-bottom .card').forEach(el=>el.classList.remove('selected'));
        const hb=[...document.querySelectorAll('#hand-bottom .card')];
        const need=c.map(x=>x.suit+x.rank);
        hb.forEach(el=>{ const key=el.textContent; const idx=need.indexOf(key); if(idx>-1){ el.classList.add('selected'); need.splice(idx,1); } });
        closeHints();
      };
      grid.appendChild(row);
    });
    sec.appendChild(grid);
    hintSections.appendChild(sec);
  });
}

/* å•Ÿå‹• */
document.getElementById('playBtn').onclick=onPlay;
document.getElementById('passBtn').onclick=onPass;
document.getElementById('dealBtn').onclick=deal;
document.getElementById('hintBtn').onclick=openHints;
document.getElementById('resetScoreBtn').onclick=()=>{ scores=[10000,10000,10000,10000]; saveScores(); updateScoreUI(); logAppendText('ğŸ”„ åˆ†æ•¸å·²é‡ç½®ç‚º 10000'); };
function deal(){
  names=['ä½ ',randName(),randName(),randName()];
  document.getElementById('name-right').innerText=names[1]; document.getElementById('name-top').innerText=names[2]; document.getElementById('name-left').innerText=names[3];
  document.getElementById('pile').innerHTML=''; logBox.innerHTML=''; setLast(''); clearFX();
  buildDeck(); shuffle(deck);
  players=[[],[],[],[]];
  for(let i=0;i<52;i++) players[i%4].push(deck[i]);
  players.forEach(p=>p.sort(compareCard));
  currentPlay=null; lastWinner=-1; firstTrick=true; turn=findStart();
  render(); updateTurnUI(); info(`æŒæœ‰ â™£3 çš„ç©å®¶ï¼ˆ${names[turn]}ï¼‰å…ˆæ”»`);
  if(turn!==0) setTimeout(aiPlay,600);
}
loadScores(); deal();
</script>
</body>
</html>
