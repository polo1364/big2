<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>å¤§è€äºŒ â€” RWD v3ï¼ˆæ‰‹æ©Ÿä¸é®æ‰‹ç‰Œï¼‰</title>
<style>
  :root{
    --card-w: 56px;
    --card-h: 80px;
    --gap: 6px;
    --panel-w: min(92vw, 960px);
    --bar-h: 64px;
    --radius: 12px;
    --pile-w: 42px;
    --pile-h: 58px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(#1b2530,#000);color:#fff;font-family:"Microsoft JhengHei",sans-serif;text-align:center;overflow:hidden}
  h1{margin:8px 0}
  .table{position:relative;width:100%;height:100svh;background:rgba(255,255,255,.05)}
  .player{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .name{font-size:14px;margin-bottom:4px;opacity:.9}
  .hand{display:flex;gap:var(--gap);max-width:96vw;overflow-x:auto;padding:2px;touch-action:manipulation}
  .hand::-webkit-scrollbar{height:6px}
  .card{
    width:var(--card-w);height:var(--card-h);
    background:#fff;border-radius:8px;color:#111;font-weight:700;font-size:18px;
    display:flex;align-items:center;justify-content:center;border:2px solid #cfd8dc;
    cursor:pointer;transition:transform .15s,opacity .25s, border-color .15s; user-select:none
  }
  .card.â™¥,.card.â™¦{color:#d11}
  .selected{transform:translateY(-10px);border-color:#f5c542;box-shadow:0 0 8px #f5c542}
  .dim{opacity:.55;pointer-events:none}
  #bottom{bottom:calc(env(safe-area-inset-bottom,0) + 10px);left:50%;transform:translateX(-50%);flex-direction:column;z-index:3}
  #top{top:10px;left:50%;transform:translateX(-50%)}
  #left{top:50%;left:10px;transform:translateY(-50%) rotate(-90deg)}
  #right{top:50%;right:10px;transform:translateY(-50%) rotate(90deg)}
  #center{
    position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);
    width:var(--panel-w);max-width:92vw;background:rgba(255,255,255,.08);
    padding:10px 16px;border-radius:var(--radius);text-align:center;z-index:2
  }
  #info{font-size:13px;opacity:.9;margin-bottom:4px}
  #last-play{font-size:13px;opacity:.75;margin-bottom:6px;min-height:18px}
  #pile{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:6px}
  .badge{display:inline-block;background:#22303a;border:1px solid rgba(255,255,255,.15);padding:2px 6px;border-radius:8px;margin-right:6px;font-size:12px}
  .pile-card{
    width:var(--pile-w);height:var(--pile-h);background:#fff;border-radius:8px;border:2px solid #cfd8dc;
    display:flex;align-items:center;justify-content:center;font-weight:700;
  }
  .pile-card.â™¥,.pile-card.â™¦{color:#d11}
  button{
    margin:4px;padding:10px 16px;font-size:15px;min-height:44px;min-width:44px;
    border:none;border-radius:10px;background:#3498db;color:#fff;cursor:pointer
  }
  button:hover{background:#2980b9}
  button:disabled{opacity:.5;cursor:not-allowed;filter:grayscale(.2)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.25)}
  .count{font-size:12px;background:#22303a;border-radius:6px;padding:2px 6px;margin-top:4px}
  #log{
    position:absolute;right:10px;bottom:calc(env(safe-area-inset-bottom,0) + 10px);
    width:260px;height:260px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.12);
    border-radius:10px;overflow-y:auto;font-size:12px;text-align:left;padding:6px;z-index:2
  }
  .log-entry{margin-bottom:4px}
  .fade{animation:fly .5s ease-out forwards}
  @keyframes fly{0%{transform:scale(1.06);opacity:0}100%{transform:scale(1);opacity:1}}
  #hintPanel{
    position:absolute;left:50%;transform:translateX(-50%);
    width:var(--panel-w);max-width:960px;background:rgba(0,0,0,.9);
    border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:10px;display:none;z-index:6
  }
  #hintPanel h3{margin:0 0 8px;font-size:14px;color:#ffdd55}
  .combo-list{display:flex;flex-wrap:wrap;gap:6px;max-height:46vh;overflow-y:auto}
  .combo{padding:6px 8px;background:#20303a;border:1px solid #3a5767;border-radius:8px;font-size:14px;cursor:pointer}
  .combo:hover{background:#315366}
  .tags{font-size:11px;opacity:.8;margin-left:6px}
  #hintClose{position:absolute;top:6px;right:8px}
  #overlay{position:absolute;inset:0;display:none;background:transparent;z-index:5}
  #musicBtn{position:absolute;top:10px;right:10px;background:#3a5a70;z-index:7}
  #logToggle{position:absolute;top:10px;left:10px;z-index:7}

  /* === æ‰‹æ©Ÿï¼šä¸é®æ‰‹ç‰Œçš„æç¤ºã€Œæ¢ç‹€åˆ—ã€ === */
  #hintStrip{
    display:none;
    width:96vw;max-width:960px;margin:6px auto 8px auto;padding:6px 6px;
    background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.14);border-radius:10px;
    overflow-x:auto;white-space:nowrap;gap:6px;scrollbar-width:thin
  }
  #hintStrip .chip{
    display:inline-block;margin-right:6px;padding:6px 8px;border-radius:999px;
    background:#20303a;border:1px solid #3a5767;font-size:13px;cursor:pointer
  }
  #hintStrip .chip .tags{margin-left:4px}

  body.is-mobile :root{ --card-w: 44px; --card-h: 62px; --gap: 4px; --pile-w: 34px; --pile-h: 48px;}
  body.is-mobile #left, body.is-mobile #right{ transform:translateY(-50%); }
  body.is-mobile .player:not(#bottom) .hand{ display:none }
  body.is-mobile #center{ top:30%; width:94vw }
  #actionBar{
    position:fixed;left:0;right:0;bottom:0;display:none;gap:8px;
    padding:8px 12px calc(env(safe-area-inset-bottom,0) + 8px);
    background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.55));
    backdrop-filter:blur(6px); align-items:center; justify-content:center; z-index:6
  }
  body.is-mobile #actionBar{ display:flex }
  body.is-mobile #center .controls{ display:none }
  body.is-mobile button{ padding:10px 14px; font-size:15px }
  body.is-mobile #log{
    width:56vw;height:36vh;right:8px;bottom:calc(env(safe-area-inset-bottom,0) + 80px);font-size:11px;display:none
  }
  /* æç¤ºé¢æ¿ï¼šæ‰‹æ©Ÿç‚ºé ‚éƒ¨æŠ½å±œï¼ˆé¿å…é®ä½åº•éƒ¨æ‰‹ç‰Œï¼‰ */
  body.is-mobile #hintPanel{ top:0; bottom:auto; left:50%; transform:translateX(-50%); width:100vw; border-radius:0 0 14px 14px }
  body.is-mobile #overlay{ display:block }
  /* æç¤ºæ¢ï¼šæ‰‹æ©Ÿé¡¯ç¤ºåœ¨ç©å®¶åå­—èˆ‡æ‰‹ç‰Œä¹‹é–“ï¼Œä¸æœƒé®ä½æ‰‹ç‰Œ */
  body.is-mobile #hintStrip{ display:block }
</style>
</head>
<body>
  <h1>å¤§è€äºŒ</h1>
  <button id="musicBtn">ğŸµ éŸ³æ¨‚ ON</button>
  <button id="logToggle" class="btn-ghost">ğŸ“ æˆ°æ³</button>
  <audio id="bgm" loop autoplay>
    <source src="https://actions.google.com/sounds/v1/ambiences/board_game_ambience.ogg" type="audio/ogg">
  </audio>

  <div class="table" id="table">
    <div id="top" class="player"><div class="name" id="name-top"></div><div class="hand" id="hand-top"></div><div class="count" id="cnt-top"></div></div>
    <div id="left" class="player"><div class="name" id="name-left"></div><div class="hand" id="hand-left"></div><div class="count" id="cnt-left"></div></div>
    <div id="right" class="player"><div class="name" id="name-right"></div><div class="hand" id="hand-right"></div><div class="count" id="cnt-right"></div></div>
    <div id="bottom" class="player">
      <div class="name" id="name-bottom">ä½ </div>
      <!-- æ‰‹æ©Ÿä¸é®æ‰‹ç‰Œçš„æç¤ºæ¢ -->
      <div id="hintStrip" aria-label="å¿«æ·æç¤ºæ¢ï¼ˆå¯æ©«å‘æ²å‹•ï¼‰"></div>
      <div class="hand" id="hand-bottom"></div>
      <div class="count" id="cnt-bottom"></div>
    </div>

    <div id="center">
      <div id="info">è¼‰å…¥ä¸­...</div>
      <div id="last-play"></div>
      <div id="pile" aria-label="ä¸Ÿç‰Œå€"></div>
      <div class="controls">
        <button id="playBtn" disabled>å‡ºç‰Œ</button>
        <button id="passBtn" disabled>PASS</button>
        <button id="hintBtn">é¡¯ç¤ºæç¤º</button>
        <button id="dealBtn">é‡æ–°ç™¼ç‰Œ</button>
      </div>
    </div>

    <div id="actionBar" role="toolbar" aria-label="æ“ä½œåˆ—">
      <button id="playBtn_m" disabled>å‡ºç‰Œ</button>
      <button id="passBtn_m" disabled>PASS</button>
      <button id="hintBtn_m">æç¤º</button>
      <button id="dealBtn_m">é‡ç™¼</button>
    </div>

    <div id="log" aria-label="æˆ°æ³ç´€éŒ„"></div>
    <div id="hintPanel" aria-label="æç¤ºé¢æ¿">
      <button id="hintClose" class="btn-ghost">æ”¶èµ·</button>
      <h3>å¯å‡ºçš„çµ„åˆï¼ˆé»æ“Šè‡ªå‹•é¸æ“‡ï¼‰</h3>
      <div class="combo-list" id="comboList"></div>
    </div>
    <div id="overlay"></div>
  </div>

<script>
/* ====== ç‰ˆé¢ï¼†éŸ³æ¨‚ ====== */
function applyLayout(){
  const isMobile = window.innerWidth <= 820 || window.innerHeight <= 650;
  document.body.classList.toggle('is-mobile', isMobile);
  const w = Math.min(72, Math.max(40, Math.floor(window.innerWidth/22)));
  const h = Math.floor(w*1.42);
  document.documentElement.style.setProperty('--card-w', w+'px');
  document.documentElement.style.setProperty('--card-h', h+'px');
}
window.addEventListener('resize', applyLayout);
applyLayout();

const bgm = document.getElementById('bgm');
const musicBtn = document.getElementById('musicBtn');
let musicOn = true;
function updateMusicBtn(){ musicBtn.textContent = musicOn ? 'ğŸµ éŸ³æ¨‚ ON' : 'ğŸµ éŸ³æ¨‚ OFF'; }
musicBtn.addEventListener('click', ()=>{ musicOn=!musicOn; bgm.muted=!musicOn; updateMusicBtn(); });
document.addEventListener('pointerdown', ()=>{ if(bgm.paused && musicOn){ bgm.play().catch(()=>{});} }, { once:true });
updateMusicBtn();

/* ====== éŠæˆ²è³‡æ–™ ====== */
const SUITS=['â™£','â™¦','â™¥','â™ '], RANKS=['3','4','5','6','7','8','9','10','J','Q','K','A','2'];
const suitOrder={'â™£':0,'â™¦':1,'â™¥':2,'â™ ':3};
const rIdx=r=>RANKS.indexOf(r);
const compareCard=(a,b)=>(rIdx(a.rank)-rIdx(b.rank))||(suitOrder[a.suit]-suitOrder[b.suit]);
let deck=[], players=[[],[],[],[]], turn=0, currentPlay=null, lastWinner=-1, firstTrick=true, names=[];
const logBox=document.getElementById('log');
const info = t => document.getElementById('info').innerText=t;
const lastText = t => document.getElementById('last-play').innerText=t||'';
function logPush(t){ const d=document.createElement('div'); d.className='log-entry fade'; d.innerText=t; logBox.prepend(d); }
function randName(){const a="ç‹æå¼µé™³æ—å³é»ƒè”¡æ¥Šè¨±é„­ä½•éƒ­ç¾…é«˜èƒ¡è•­æ½˜æ±Ÿé¾æ›¾è³´å‘‚å­«é­è‘‰é˜®é‚±å½­é¡è¬å®‹å”é¦®é‚µéŸ“æ›¹é‚¢é¡§";
const b="å‡±å®‡å®¶è±ªå¿—å‰å† å»·å»ºå®å¿—è±ªä¿Šå‚‘æ˜å“²å† éœ–ä¿Šå®‡æ‰¿ç¿°æŸå®‡å®—æ†²æ€¡å›æ¬£æ€¡é›…å©·é›…é›¯ä½³è“‰ä½©çŠæƒ é›¯å¿—ç²ç¾ç²";
function pick(s,n){let o="";for(let i=0;i<n;i++)o+=s[Math.floor(Math.random()*s.length)];return o;} return pick(a,1)+pick(b,Math.random()<0.5?1:2); }
function playSound(type){
  const url={ play:"https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg",
              pass:"https://actions.google.com/sounds/v1/cartoon/wood_plank_clank.ogg",
              start:"https://actions.google.com/sounds/v1/cartoon/slide_whistle_up.ogg",
              win:"https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" }[type];
  if(!url) return; const a=new Audio(url); a.volume=0.35; a.play().catch(()=>{});
}

/* ====== ç™¼ç‰Œèˆ‡æ¸²æŸ“ ====== */
function buildDeck(){ deck=[]; for(const s of SUITS){ for(const r of RANKS){ deck.push({suit:s,rank:r}); } } }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function findStart(){ for(let i=0;i<4;i++){ if(players[i].some(c=>c.rank==='3'&&c.suit==='â™£')) return i; } return 0; }

function render(){
  const ids=['hand-bottom','hand-right','hand-top','hand-left'];
  ids.forEach((id,i)=>{
    const area=document.getElementById(id); area.innerHTML='';
    players[i].forEach((c,idx)=>{
      const d=document.createElement('div');
      d.className=`card ${c.suit}`; d.textContent=c.suit+c.rank;
      d.dataset.idx = idx;
      if(i!==0) d.classList.add('dim');
      area.appendChild(d);
    });
  });
  document.getElementById('cnt-bottom').innerText=players[0].length;
  document.getElementById('cnt-right').innerText=players[1].length;
  document.getElementById('cnt-top').innerText=players[2].length;
  document.getElementById('cnt-left').innerText=players[3].length;
}

// è§¸æ§ï¼šå–®ä¸€ pointerdown ä»£ç†ï¼Œé¿å… click èˆ‡ pointer é›™é‡è§¸ç™¼
document.getElementById('hand-bottom').addEventListener('pointerdown', e=>{
  const card=e.target.closest('.card'); if(!card) return;
  card.classList.toggle('selected');
}, {passive:true});

function updateTurnUI(){
  const mine = (turn===0);
  ['playBtn','passBtn','playBtn_m','passBtn_m'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.disabled = !mine;
  });
  info(mine ? (firstTrick?'è¼ªåˆ°ä½ ï¼ˆé¦–æ”»éœ€å« â™£3ï¼‰':'è¼ªåˆ°ä½ ') : `ç­‰å¾… ${names[turn]} å‡ºç‰Œâ€¦`);
}

function deal(){
  names=['ä½ ',randName(),randName(),randName()];
  document.getElementById('name-right').innerText=names[1];
  document.getElementById('name-top').innerText=names[2];
  document.getElementById('name-left').innerText=names[3];
  logBox.innerHTML=''; lastText(''); document.getElementById('pile').innerHTML='';
  buildDeck(); shuffle(deck);
  players=[[],[],[],[]];
  for(let i=0;i<52;i++) players[i%4].push(deck[i]);
  players.forEach(p=>p.sort(compareCard));
  currentPlay=null; lastWinner=-1; firstTrick=true; turn=findStart();
  render(); updateTurnUI();
  info(`æŒæœ‰ â™£3 çš„ç©å®¶ï¼ˆ${names[turn]}ï¼‰å…ˆæ”»ï¼Œä¸”é¦–æ”»å¿…é ˆåŒ…å« â™£3`); playSound('start');
  if(turn!==0) setTimeout(aiPlay,700);
}

/* ====== ç‰Œå‹èˆ‡æ¯”å¤§å° ====== */
function isConsec(s){ for(let i=1;i<s.length;i++){ if(rIdx(s[i].rank)!==rIdx(s[i-1].rank)+1) return false; } return true; }
function analyze(cs){
  const n=cs.length, s=[...cs].sort(compareCard);
  if(n===1) return {ok:true,kind:'single',high:s[0]};
  if(n===2 && s[0].rank===s[1].rank) return {ok:true,kind:'pair',high:s[1]};
  if(n===3 && s.every(c=>c.rank===s[0].rank)) return {ok:true,kind:'triple',high:s[2]};
  if(n===4 && s.every(c=>c.rank===s[0].rank)) return {ok:true,kind:'four',high:s[3]};
  if(n===5){
    const rc={}; s.forEach(c=>rc[c.rank]=(rc[c.rank]||0)+1);
    const vals=Object.values(rc).sort((a,b)=>b-a);
    const sameSuit=s.every(c=>c.suit===s[0].suit);
    const consec=isConsec(s);
    if(sameSuit&&consec) return {ok:true,kind:'sf',high:s[4]};
    if(vals[0]===3&&vals[1]===2){
      const trip=Object.keys(rc).find(r=>rc[r]===3);
      const high=s.filter(c=>c.rank===trip).slice(-1)[0];
      return {ok:true,kind:'fullhouse',high};
    }
    if(consec) return {ok:true,kind:'straight',high:s[4]};
  }
  return {ok:false};
}
const strVal={'single':1,'pair':1,'triple':1,'straight':2,'fullhouse':3,'four':4,'sf':5};
function canBeat(a,b){
  if(!b) return true;
  const A=analyze(a), B=analyze(b);
  if(!A.ok) return false;
  if(A.kind===B.kind){
    const r=rIdx(A.high.rank)-rIdx(B.high.rank);
    if(r!==0) return r>0;
    return suitOrder[A.high.suit]>suitOrder[B.high.suit];
  }
  if(A.kind==='four' && (B.kind==='fullhouse'||B.kind==='straight'||B.kind==='pair')) return true;
  if(A.kind==='sf'   && (B.kind==='four'||B.kind==='fullhouse'||B.kind==='straight'||B.kind==='pair')) return true;
  return false;
}

/* ====== çµ„åˆç”Ÿæˆ ====== */
function combos(hand){
  const res=[],map={};
  hand.forEach(c=>(map[c.rank]=map[c.rank]||[]).push(c));
  hand.forEach(c=>res.push([c]));
  for(const r in map) if(map[r].length>=2){
    const a=map[r].slice().sort(compareCard);
    for(let i=0;i<a.length;i++) for(let j=i+1;j<a.length;j++) res.push([a[i],a[j]]);
  }
  for(const r in map) if(map[r].length>=3){
    const a=map[r].slice().sort(compareCard);
    for(let i=0;i<a.length;i++) for(let j=i+1;j<a.length;j++) for(let k=j+1;k<a.length;k++) res.push([a[i],a[j],a[k]]);
  }
  for(const r in map) if(map[r].length===4) res.push(map[r].slice());
  const n=hand.length;
  for(let a=0;a<n;a++) for(let b=a+1;b<n;b++) for(let c=b+1;c<n;c++) for(let d=c+1;d<n;d++) for(let e=d+1;e<n;e++){
    const pack=[hand[a],hand[b],hand[c],hand[d],hand[e]];
    const an=analyze(pack);
    if(an.ok && (an.kind==='straight'||an.kind==='fullhouse'||an.kind==='sf')) res.push(pack);
  }
  res.sort((x,y)=>{
    const A=analyze(x), B=analyze(y);
    if(strVal[A.kind]!==strVal[B.kind]) return strVal[A.kind]-strVal[B.kind];
    const r=rIdx(A.high.rank)-rIdx(B.high.rank);
    return r!==0? r : (suitOrder[A.high.suit]-suitOrder[B.high.suit]);
  });
  return res;
}

/* ====== AI ====== */
function aiPlay(){
  const i=turn, hand=players[i];
  if(hand.length===1){ play(i,[hand[0]]); return; }
  const all=combos(hand);
  const enemyAlmostWin = players.some((p,idx)=>idx!==i && p.length<=2);
  let options=[];
  if(!currentPlay){ options = firstTrick? all.filter(c=>c.some(x=>x.rank==='3'&&x.suit==='â™£')) : (enemyAlmostWin? all.filter(c=>analyze(c).kind!=='single') : all); }
  else options = all.filter(c=>canBeat(c,currentPlay));
  const filtered=options.filter(c=>{
    const k=analyze(c).kind;
    if((k==='four'||k==='sf') && !enemyAlmostWin && hand.length>6) return false;
    return true;
  });
  if(enemyAlmostWin){
    const bomb=options.find(c=>['four','sf'].includes(analyze(c).kind));
    if(bomb){ play(i,bomb); return; }
  }
  const choice=(filtered.length?filtered:options)[0];
  if(choice) play(i,choice); else { info(`${names[i]} PASS`); logPush(`${names[i]} PASS`); playSound('pass'); next(); }
}

/* ====== å‡ºç‰Œã€å›åˆã€ä¸Ÿç‰Œå€ UI ====== */
function toStr(cards){ return cards.map(c=>c.suit+c.rank).join(' '); }
function renderPile(playerName,cards,kind){
  const pile=document.getElementById('pile'); pile.innerHTML='';
  const who=document.createElement('div'); who.className='badge'; who.innerText=playerName;
  const k=document.createElement('div'); k.className='badge'; k.innerText=kind;
  const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='center'; row.style.gap='8px'; row.style.flexWrap='wrap';
  cards.forEach(c=>{
    const d=document.createElement('div'); d.className='pile-card '+c.suit; d.textContent=c.suit+c.rank; row.appendChild(d);
  });
  pile.appendChild(who); pile.appendChild(k); pile.appendChild(row);
}
function play(i,cards){
  cards.forEach(c=>{ const idx=players[i].findIndex(p=>p.rank===c.rank&&p.suit===c.suit); if(idx>-1) players[i].splice(idx,1); });
  render();
  const an=analyze(cards);
  currentPlay=cards; lastWinner=i; firstTrick=false;
  lastText(`${names[i]} å‡ºç‰Œ`); renderPile(names[i], cards, an.kind); logPush(`${names[i]}ï¼š${toStr(cards)}ï¼ˆ${an.kind}ï¼‰`); playSound('play');
  if(players[i].length===0){ info(`${names[i]} è„«æ‰‹å‹åˆ©ï¼`); logPush(`${names[i]} ç²å‹ï¼`); playSound('win'); turn=-1; return; }
  next();
}
function next(){
  if(turn<0) return;
  turn=(turn+1)%4;
  if(turn===lastWinner){ currentPlay=null; lastText(`${names[turn]} é‡æ–°å‡ºç‰Œ`); document.getElementById('pile').innerHTML=''; }
  updateTurnUI();
  if(turn!==0) setTimeout(aiPlay,800);
}

function selected(){
  const elCards=[...document.querySelectorAll('#hand-bottom .card')];
  return elCards.filter(el=>el.classList.contains('selected'))
                .map(el=>players[0][parseInt(el.dataset.idx,10)]);
}

function onPlay(){
  if(turn!==0) return;
  const cs=selected();
  if(!cs.length){ info('è«‹å…ˆé¸ç‰Œ'); return; }
  const an=analyze(cs);
  if(!an.ok){ info('ä¸åˆæ³•çµ„åˆ'); return; }
  if(firstTrick && !cs.some(c=>c.rank==='3'&&c.suit==='â™£')){ info('é¦–æ”»å¿…å« â™£3'); return; }
  if(currentPlay && !canBeat(cs,currentPlay)){ info('æ¯”ä¸éå‰å®¶'); return; }
  play(0,cs);
}
document.getElementById('playBtn').onclick=onPlay;
document.getElementById('passBtn').onclick=()=>{ if(turn!==0) return; info('ä½  PASS'); logPush('ä½  PASS'); playSound('pass'); next(); };
document.getElementById('hintBtn').onclick=()=>openPanel();
document.getElementById('dealBtn').onclick=deal;
document.getElementById('playBtn_m').onclick=onPlay;
document.getElementById('passBtn_m').onclick=()=>{ if(turn!==0) return; info('ä½  PASS'); logPush('ä½  PASS'); playSound('pass'); next(); };
document.getElementById('hintBtn_m').onclick=()=>toggleMobileHints(); // æ‰‹æ©ŸæŒ‰éˆ•â†’åˆ‡æ›æ¢ç‹€åˆ—
document.getElementById('dealBtn_m').onclick=deal;

/* ====== æç¤ºï¼šæ‰‹æ©Ÿã€Œæ¢ç‹€åˆ—ã€ï¼‹ å…¨åŠŸèƒ½é¢æ¿ ====== */
function legalCombos(){
  const hand=players[0]; let arr=combos(hand);
  if(firstTrick) arr=arr.filter(c=>c.some(x=>x.rank==='3'&&x.suit==='â™£'));
  if(currentPlay) arr=arr.filter(c=>canBeat(c,currentPlay));
  return arr;
}
// æ‰‹æ©Ÿå¿«æ·æ¢ï¼ˆä¸é®æ‰‹ç‰Œï¼‰
const strip = document.getElementById('hintStrip');
function populateStrip(){
  strip.innerHTML='';
  const arr = legalCombos();
  if(arr.length===0){ strip.textContent='ï¼ˆç›®å‰æ²’æœ‰å¯å‡ºçš„ç‰Œï¼‰'; return; }
  arr.slice(0,18).forEach(c=>{
    const chip=document.createElement('div'); chip.className='chip'; chip.textContent=toStr(c);
    const tag=document.createElement('span'); tag.className='tags'; tag.textContent=analyze(c).kind; chip.appendChild(tag);
    chip.onclick=()=>{
      document.querySelectorAll('#hand-bottom .card').forEach(el=>el.classList.remove('selected'));
      const hb=[...document.querySelectorAll('#hand-bottom .card')];
      const need=c.map(x=>x.suit+x.rank);
      hb.forEach(el=>{ const key=el.textContent; const idx=need.indexOf(key); if(idx>-1){ el.classList.add('selected'); need.splice(idx,1); } });
    };
    strip.appendChild(chip);
  });
  const more=document.createElement('div'); more.className='chip'; more.textContent='æ›´å¤šâ€¦'; more.style.background='#29465a';
  more.onclick=()=>openPanel();
  strip.appendChild(more);
}
function toggleMobileHints(){
  if(strip.dataset.open==='1'){ strip.dataset.open='0'; strip.style.display='none'; }
  else { strip.dataset.open='1'; strip.style.display='block'; populateStrip(); }
}
// æ¡Œæ©Ÿ/å…¨åŠŸèƒ½é¢æ¿
const panel=document.getElementById('hintPanel');
const overlay=document.getElementById('overlay');
document.getElementById('hintClose').onclick=closePanel;
overlay.onclick=closePanel;
function openPanel(){
  const list=document.getElementById('comboList'); list.innerHTML='';
  const arr=legalCombos();
  panel.style.display='block'; overlay.style.display = document.body.classList.contains('is-mobile') ? 'block' : 'none';
  if(arr.length===0){ const none=document.createElement('div'); none.innerText='ï¼ˆç›®å‰æ²’æœ‰å¯å‡ºçš„ç‰Œï¼‰'; list.appendChild(none); return; }
  arr.slice(0,180).forEach(c=>{
    const an=analyze(c);
    const div=document.createElement('div'); div.className='combo'; div.innerText=toStr(c);
    const tag=document.createElement('span'); tag.className='tags'; tag.innerText=an.kind; div.appendChild(tag);
    div.onclick=()=>{
      document.querySelectorAll('#hand-bottom .card').forEach(el=>el.classList.remove('selected'));
      const hb=[...document.querySelectorAll('#hand-bottom .card')];
      const need=c.map(x=>x.suit+x.rank);
      hb.forEach(el=>{ const key=el.textContent; const idx=need.indexOf(key); if(idx>-1){ el.classList.add('selected'); need.splice(idx,1); } });
    };
    list.appendChild(div);
  });
}
function closePanel(){ panel.style.display='none'; overlay.style.display='none'; }

/* ====== æˆ°æ³é¢æ¿ï¼ˆæ‰‹æ©Ÿé–‹é—œï¼‰ ====== */
document.getElementById('logToggle').onclick=()=>{ const l=document.getElementById('log'); l.style.display = (l.style.display==='none'||!l.style.display)?'block':'none'; };

/* ====== é–‹å§‹ ====== */
deal();
</script>
</body>
</html>
