<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>üê≠ Âêâ‰ºäÂç°ÂìáÂ§ßËÄÅ‰∫å üíï</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
/* ====== CSS Variables & Theme ====== */
:root {
  --card-w: 72px;
  --card-h: 102px;
  --pile-w: 52px;
  --pile-h: 74px;
  --panel-w: min(92vw, 960px);
  
  /* Chiikawa Color Palette - Soft & Dreamy */
  --cream: #FFF8F0;
  --soft-pink: #FFE4EC;
  --blush: #FFB8D0;
  --coral: #FF9BAA;
  --peach: #FFDAB9;
  --lavender: #E8D4F0;
  --mint: #D4F0E0;
  --sky: #D4E8F0;
  --honey: #FFE4A0;
  --brown: #8B6F5C;
  --dark-brown: #5C4A3D;
  
  /* Semantic Colors */
  --primary: var(--blush);
  --primary-hover: var(--coral);
  --success: #98D89D;
  --danger: #FF8B94;
  --warning: var(--honey);
  --text-primary: var(--dark-brown);
  --text-secondary: var(--brown);
  
  /* Shadows */
  --shadow-soft: 0 4px 20px rgba(139, 111, 92, 0.12);
  --shadow-medium: 0 8px 32px rgba(139, 111, 92, 0.18);
  --shadow-glow: 0 0 30px rgba(255, 184, 208, 0.4);
}

/* ====== Reset & Base ====== */
*, *::before, *::after {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  padding: 0;
  min-height: 100dvh;
  font-family: 'Zen Maru Gothic', 'Kosugi Maru', "Microsoft JhengHei", system-ui, sans-serif;
  color: var(--text-primary);
  user-select: none;
  overflow: hidden;
  background: var(--cream);
}

/* ====== Animated Background ====== */
.bg-container {
  position: fixed;
  inset: 0;
  z-index: 0;
  overflow: hidden;
  background: linear-gradient(180deg, var(--cream) 0%, var(--soft-pink) 100%);
}

.bg-blob {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.6;
  animation: float 20s ease-in-out infinite;
}

.bg-blob:nth-child(1) {
  width: 60vmax;
  height: 60vmax;
  background: var(--lavender);
  top: -20%;
  left: -10%;
  animation-delay: 0s;
}

.bg-blob:nth-child(2) {
  width: 50vmax;
  height: 50vmax;
  background: var(--peach);
  top: 50%;
  right: -15%;
  animation-delay: -5s;
}

.bg-blob:nth-child(3) {
  width: 40vmax;
  height: 40vmax;
  background: var(--mint);
  bottom: -10%;
  left: 20%;
  animation-delay: -10s;
}

.bg-blob:nth-child(4) {
  width: 35vmax;
  height: 35vmax;
  background: var(--sky);
  top: 30%;
  left: 50%;
  animation-delay: -15s;
}

@keyframes float {
  0%, 100% { transform: translate(0, 0) scale(1); }
  25% { transform: translate(30px, -30px) scale(1.05); }
  50% { transform: translate(-20px, 20px) scale(0.95); }
  75% { transform: translate(20px, 30px) scale(1.02); }
}

/* Floating decorative elements */
.floating-deco {
  position: absolute;
  font-size: 2rem;
  opacity: 0.3;
  animation: floatDeco 15s ease-in-out infinite;
  pointer-events: none;
}

@keyframes floatDeco {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-20px) rotate(10deg); }
}

/* ====== Stage Layout ====== */
#stage {
  position: relative;
  width: 100%;
  height: 100dvh;
  display: grid;
  grid-template-rows: auto 1fr auto;
  z-index: 1;
}

/* ====== Top Bar ====== */
.topbar {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: max(12px, env(safe-area-inset-top)) 16px 12px;
  gap: 12px;
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 2px solid rgba(255, 184, 208, 0.3);
  position: relative;
  z-index: 50;
}

h1 {
  margin: 0;
  font-weight: 900;
  font-size: clamp(1.25rem, 4vw, 1.75rem);
  letter-spacing: 2px;
  background: linear-gradient(135deg, var(--coral) 0%, var(--blush) 50%, var(--lavender) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: none;
  position: relative;
}

h1::after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 50%;
  transform: translateX(-50%);
  width: 60%;
  height: 3px;
  background: linear-gradient(90deg, transparent, var(--blush), transparent);
  border-radius: 2px;
}

/* ====== Sound Toggle Buttons ====== */
.sound-toggles {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 8px;
  z-index: 60;
}

.toggle-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 2px solid var(--blush);
  background: rgba(255, 255, 255, 0.9);
  color: var(--brown);
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-soft);
}

.toggle-btn:hover {
  transform: scale(1.1);
  background: var(--soft-pink);
  box-shadow: var(--shadow-medium);
}

.toggle-btn:active {
  transform: scale(0.95);
}

.toggle-btn.off {
  opacity: 0.5;
  background: rgba(200, 200, 200, 0.5);
}

/* ====== Table Layout ====== */
.table {
  position: relative;
  flex: 1;
  display: grid;
  grid-template-columns: 1fr minmax(300px, var(--panel-w)) 1fr;
  grid-template-rows: auto 1fr auto;
  height: 100%;
  gap: 8px;
  padding: 8px;
}

/* ====== Player Styles ====== */
.player {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 8px;
}

.player-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--soft-pink), var(--lavender));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  border: 3px solid white;
  box-shadow: var(--shadow-soft);
  position: relative;
  overflow: hidden;
}

.player-avatar::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);
}

.player.active .player-avatar {
  animation: pulse 1.5s ease-in-out infinite;
  box-shadow: var(--shadow-glow);
}

@keyframes pulse {
  0%, 100% { transform: scale(1); box-shadow: var(--shadow-glow); }
  50% { transform: scale(1.05); box-shadow: 0 0 40px rgba(255, 184, 208, 0.6); }
}

.name {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--text-primary);
  text-shadow: 0 1px 2px rgba(255,255,255,0.8);
}

.player-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.score {
  font-size: 0.8rem;
  font-weight: 700;
  background: rgba(255, 255, 255, 0.85);
  padding: 4px 12px;
  border-radius: 20px;
  box-shadow: var(--shadow-soft);
  color: var(--text-secondary);
  border: 2px solid rgba(255, 184, 208, 0.3);
}

.count {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--coral);
  background: rgba(255, 255, 255, 0.85);
  padding: 4px 10px;
  border-radius: 12px;
  box-shadow: var(--shadow-soft);
}

.count::before {
  content: 'üÉè ';
}

/* Hide opponent hands */
.player:not(#p-bottom) .hand { display: none; }

/* ====== Hand Container ====== */
.hand {
  display: flex;
  gap: 6px;
  max-width: 96vw;
  overflow-x: auto;
  overflow-y: hidden;
  padding: 12px 8px;
  touch-action: pan-x;
  pointer-events: auto;
  scroll-behavior: smooth;
  scrollbar-width: thin;
  scrollbar-color: var(--blush) transparent;
}

.hand::-webkit-scrollbar {
  height: 6px;
}

.hand::-webkit-scrollbar-track {
  background: transparent;
}

.hand::-webkit-scrollbar-thumb {
  background: var(--blush);
  border-radius: 10px;
}

#hand-bottom.two-rows {
  flex-wrap: wrap;
  row-gap: 10px;
  justify-content: center;
  overflow-x: hidden;
  max-width: 100%;
}

#hand-bottom.two-rows .card {
  width: calc(var(--card-w) * 0.85);
  height: calc(var(--card-w) * 0.85 * 1.42);
  min-width: calc(var(--card-w) * 0.85);
  font-size: 1.2rem;
}

/* ====== Card Styles ====== */
.card {
  position: relative;
  width: var(--card-w);
  height: var(--card-h);
  min-width: var(--card-w);
  background: linear-gradient(145deg, #ffffff 0%, #fefefe 100%);
  border-radius: 14px;
  border: 3px solid #e8e0d8;
  color: var(--text-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 1.4rem;
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  touch-action: manipulation;
  cursor: pointer;
  box-shadow: 
    0 4px 8px rgba(139, 111, 92, 0.1),
    0 2px 4px rgba(139, 111, 92, 0.08),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 50%;
  background: linear-gradient(180deg, rgba(255,255,255,0.6) 0%, transparent 100%);
  pointer-events: none;
  border-radius: 11px 11px 0 0;
}

.card::after {
  content: '';
  position: absolute;
  inset: 4px;
  border: 1px dashed rgba(139, 111, 92, 0.1);
  border-radius: 10px;
  pointer-events: none;
}

.card:hover {
  transform: translateY(-12px) scale(1.02);
  box-shadow: 
    0 16px 32px rgba(139, 111, 92, 0.2),
    0 8px 16px rgba(139, 111, 92, 0.15);
  border-color: var(--blush);
}

/* Card Suits */
.card.‚ô•, .card.‚ô¶ {
  color: #E53E3E;
}

.card.‚ô†, .card.‚ô£ {
  color: #2D3748;
}

.card.‚ô•::after, .card.‚ô¶::after {
  border-color: rgba(229, 62, 62, 0.1);
}

/* Selected Card */
.card.selected {
  transform: translateY(-28px) scale(1.05);
  border-color: var(--honey);
  box-shadow: 
    0 20px 40px rgba(255, 215, 0, 0.3),
    0 0 0 4px rgba(255, 228, 160, 0.5),
    inset 0 0 20px rgba(255, 228, 160, 0.3);
  background: linear-gradient(145deg, #FFFEF5 0%, #FFF8E7 100%);
}

.card.selected::before {
  background: linear-gradient(180deg, rgba(255, 248, 220, 0.8) 0%, transparent 100%);
}

/* Card suit indicator */
.card-suit {
  font-size: 0.75rem;
  opacity: 0.8;
  margin-top: 2px;
}

/* ====== Center Panel ====== */
#centerPanel {
  grid-column: 2;
  grid-row: 2;
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(30px);
  -webkit-backdrop-filter: blur(30px);
  border: 2px solid rgba(255, 184, 208, 0.4);
  border-radius: 28px;
  padding: 16px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  position: relative;
  box-shadow: 
    var(--shadow-medium),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  max-height: calc(100% - 20px);
  overflow: hidden;
}

/* Panel decorative corners */
#centerPanel::before,
#centerPanel::after {
  content: '‚úø';
  position: absolute;
  font-size: 1.2rem;
  opacity: 0.3;
  color: var(--coral);
}

#centerPanel::before { top: 10px; left: 14px; }
#centerPanel::after { bottom: 10px; right: 14px; }

/* ====== Center Tools ====== */
#centerTools {
  display: flex;
  gap: 8px;
  width: 100%;
  justify-content: space-between;
  flex-wrap: wrap;
}

.ct-side {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

/* ====== FX Container ====== */
#fx {
  position: absolute;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 10;
  border-radius: 26px;
}

/* ====== Info Display ====== */
#info {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-primary);
  text-align: center;
  padding: 8px 16px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 16px;
  min-width: 200px;
}

#last {
  font-size: 0.85rem;
  color: var(--text-secondary);
  min-height: 20px;
  text-align: center;
}

/* ====== Pile Area ====== */
#pile {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  min-height: 100px;
  padding: 12px;
  background: rgba(255, 248, 240, 0.6);
  border-radius: 20px;
  border: 2px dashed rgba(255, 184, 208, 0.3);
  width: 100%;
  max-width: 500px;
}

.pile-header {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--text-secondary);
}

.pile-cards {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
}

.pile-card {
  width: var(--pile-w);
  height: var(--pile-h);
  background: linear-gradient(145deg, #ffffff 0%, #fefefe 100%);
  border-radius: 10px;
  border: 2px solid #e8e0d8;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 1rem;
  box-shadow: var(--shadow-soft);
  transition: transform 0.3s ease;
}

.pile-card.‚ô•, .pile-card.‚ô¶ { color: #E53E3E; }
.pile-card.‚ô†, .pile-card.‚ô£ { color: #2D3748; }

#pile.highlight-pile .pile-card {
  animation: cardGlow 0.8s ease-in-out;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
  border-color: var(--honey);
}

@keyframes cardGlow {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* ====== Log Area ====== */
#logCenter {
  width: 100%;
  max-height: 120px;
  overflow-y: auto;
  border-radius: 16px;
  padding: 10px;
  background: rgba(255, 248, 240, 0.5);
  border: 1px solid rgba(255, 184, 208, 0.2);
  font-size: 0.8rem;
  scrollbar-width: thin;
  scrollbar-color: var(--blush) transparent;
}

#logCenter::-webkit-scrollbar {
  width: 4px;
}

#logCenter::-webkit-scrollbar-thumb {
  background: var(--blush);
  border-radius: 4px;
}

.log-line {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  margin: 4px 0;
  border-radius: 10px;
  transition: background 0.2s ease;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}

.log-line:hover {
  background: rgba(255, 255, 255, 0.5);
}

.log-who {
  font-weight: 700;
  min-width: 60px;
  text-align: right;
  color: var(--text-primary);
}

.log-kind {
  font-weight: 600;
  color: var(--text-secondary);
  background: rgba(255, 184, 208, 0.2);
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 0.75rem;
}

.log-cards {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.log-card {
  width: 28px;
  height: 38px;
  background: white;
  border: 2px solid #e8e0d8;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 0.65rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.log-card.‚ô•, .log-card.‚ô¶ { color: #E53E3E; }
.log-card.‚ô†, .log-card.‚ô£ { color: #2D3748; }

/* ====== Action Row ====== */
.actionRow {
  grid-column: 2;
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
  padding: 8px 0;
  position: relative;
  z-index: 30;
}

/* ====== Button Styles ====== */
button {
  font-family: inherit;
  font-weight: 700;
  padding: 12px 20px;
  border-radius: 16px;
  border: none;
  cursor: pointer;
  min-width: 100px;
  min-height: 48px;
  font-size: 1rem;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  position: relative;
  overflow: hidden;
}

button::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.3) 0%, transparent 50%);
  opacity: 0;
  transition: opacity 0.3s ease;
}

button:hover::before {
  opacity: 1;
}

button:hover {
  transform: translateY(-3px);
}

button:active {
  transform: translateY(-1px);
}

button[disabled] {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none !important;
}

/* Primary Button */
button:not(.btn-ghost) {
  background: linear-gradient(135deg, var(--blush) 0%, var(--coral) 100%);
  color: white;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  box-shadow: 
    0 4px 12px rgba(255, 155, 170, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

button:not(.btn-ghost):hover {
  box-shadow: 
    0 8px 24px rgba(255, 155, 170, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

/* Ghost Button */
.btn-ghost {
  background: rgba(255, 255, 255, 0.8);
  color: var(--text-primary);
  border: 2px solid rgba(255, 184, 208, 0.4);
  box-shadow: var(--shadow-soft);
}

.btn-ghost:hover {
  background: rgba(255, 255, 255, 0.95);
  border-color: var(--blush);
  box-shadow: var(--shadow-medium);
}

/* Small Button */
.btn-small {
  min-width: auto;
  min-height: auto;
  padding: 8px 14px;
  border-radius: 12px;
  font-size: 0.85rem;
}

/* ====== Player Positions ====== */
#p-top { grid-column: 2; grid-row: 1; }
#p-left { grid-column: 1; grid-row: 2; }
#p-right { grid-column: 3; grid-row: 2; }
#p-bottom { grid-column: 2; grid-row: 3; }

/* ====== Overlay Styles ====== */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(92, 74, 61, 0.6);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
  padding: 16px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.panel {
  width: min(94vw, 800px);
  max-height: 85vh;
  overflow: auto;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 3px solid var(--blush);
  border-radius: 28px;
  padding: 24px;
  box-shadow: 
    0 20px 60px rgba(92, 74, 61, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes slideUp {
  from { transform: translateY(40px) scale(0.95); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

.panel h2 {
  margin: 0 0 20px;
  font-size: 1.5rem;
  font-weight: 900;
  text-align: center;
  color: var(--text-primary);
  position: relative;
}

.panel h2::after {
  content: '';
  display: block;
  width: 60px;
  height: 4px;
  background: linear-gradient(90deg, var(--blush), var(--coral));
  border-radius: 2px;
  margin: 12px auto 0;
}

/* ====== Hint Panel ====== */
#hintToolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}

.chip {
  padding: 10px 16px;
  border-radius: 20px;
  background: rgba(255, 248, 240, 0.8);
  border: 2px solid rgba(255, 184, 208, 0.3);
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--text-primary);
}

.chip:hover {
  background: var(--soft-pink);
  border-color: var(--blush);
  transform: translateY(-2px);
}

.chip.active {
  background: linear-gradient(135deg, var(--honey) 0%, var(--peach) 100%);
  border-color: var(--honey);
  box-shadow: 0 4px 12px rgba(255, 228, 160, 0.4);
}

#hintSections {
  color: var(--text-secondary);
}

.section {
  margin: 16px 0;
}

.section h4 {
  margin: 0 0 12px;
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.section h4::before {
  content: '‚ñ∏';
  color: var(--coral);
}

.combo-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 10px;
}

.combo-row {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 12px;
  border-radius: 14px;
  background: rgba(255, 248, 240, 0.6);
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.3s ease;
}

.combo-row:hover {
  background: rgba(255, 255, 255, 0.8);
  border-color: var(--blush);
  transform: translateY(-2px);
  box-shadow: var(--shadow-soft);
}

.mini {
  width: 34px;
  height: 48px;
  background: white;
  border: 2px solid #e8e0d8;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 0.7rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}

.mini.‚ô•, .mini.‚ô¶ { color: #E53E3E; }
.mini.‚ô†, .mini.‚ô£ { color: #2D3748; }

.tag {
  margin-left: auto;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-secondary);
  background: rgba(255, 184, 208, 0.2);
  padding: 4px 10px;
  border-radius: 8px;
}

/* ====== Score Panel ====== */
.pList {
  list-style: none;
  margin: 0;
  padding: 0;
}

.pItem {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 16px;
  border-radius: 16px;
  background: rgba(255, 248, 240, 0.6);
  border: 2px solid transparent;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.pItem:hover {
  background: rgba(255, 255, 255, 0.8);
  border-color: rgba(255, 184, 208, 0.3);
}

.pName {
  font-weight: 800;
  font-size: 1rem;
  color: var(--text-primary);
}

.pExplain {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-top: 4px;
}

.pRight {
  display: flex;
  gap: 16px;
  align-items: center;
}

.pDelta {
  font-weight: 900;
  font-size: 1.1rem;
}

.pDelta.plus {
  color: #38A169;
}

.pDelta.minus {
  color: #E53E3E;
}

.pScore {
  font-weight: 800;
  font-size: 1rem;
  color: var(--text-primary);
}

/* Rank List */
.rank {
  list-style: none;
  margin: 16px 0;
  padding: 0;
}

.rank li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-radius: 16px;
  background: rgba(255, 248, 240, 0.6);
  border: 2px solid transparent;
  margin-bottom: 10px;
  font-weight: 700;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.rank li:first-child {
  background: linear-gradient(135deg, var(--honey) 0%, var(--peach) 100%);
  border-color: var(--honey);
}

.rank li:nth-child(2) {
  background: rgba(200, 200, 200, 0.2);
}

.rank li:nth-child(3) {
  background: rgba(205, 127, 50, 0.15);
}

/* ====== FX Animations ====== */
@keyframes fx-pop {
  0% { transform: translate(-50%, -50%) scale(0.5) rotate(-10deg); opacity: 0; }
  60% { transform: translate(-50%, -50%) scale(1.15) rotate(5deg); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
}

.fx-symbol {
  position: absolute;
  left: 50%;
  top: 40%;
  transform: translate(-50%, -50%);
  font-weight: 900;
  font-size: 3rem;
  line-height: 1;
  border-radius: 20px;
  padding: 16px 28px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 248, 240, 0.98) 100%);
  color: var(--text-primary);
  border: 4px solid var(--honey);
  box-shadow: 
    0 12px 40px rgba(139, 111, 92, 0.3),
    0 0 60px rgba(255, 228, 160, 0.5);
  animation: fx-pop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
  z-index: 20;
}

/* ====== Responsive Styles ====== */

/* Desktop */
@media (min-width: 1024px) {
  :root {
    --card-w: 80px;
    --card-h: 114px;
  }
  
  .table {
    padding-bottom: 200px;
  }
  
  #centerPanel {
    max-height: 60vh;
    overflow: auto;
  }
  
  #p-bottom {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 16px;
    z-index: 40;
    pointer-events: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: linear-gradient(180deg, transparent 0%, rgba(255, 248, 240, 0.9) 30%);
    padding-top: 20px;
    padding-bottom: env(safe-area-inset-bottom, 8px);
  }
  
  #p-bottom .hand {
    pointer-events: auto;
    max-width: min(1200px, 96vw);
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 16px;
    border: 2px solid rgba(255, 184, 208, 0.3);
    box-shadow: var(--shadow-medium);
  }
  
  .actionRow {
    position: relative;
    z-index: 50;
  }
}

/* Tablet */
@media (max-width: 1023px) and (min-width: 769px) {
  :root {
    --card-w: 68px;
    --card-h: 96px;
  }
}

/* Mobile */
@media (max-width: 768px) {
  :root {
    --card-w: 58px;
    --card-h: 82px;
    --pile-w: 44px;
    --pile-h: 62px;
  }
  
  .topbar {
    padding: max(8px, env(safe-area-inset-top)) 12px 8px;
  }
  
  .table {
    grid-template-columns: auto 1fr auto;
    gap: 4px;
    padding: 4px;
  }
  
  #centerPanel {
    padding: 12px;
    border-radius: 20px;
  }
  
  .actionRow {
    gap: 6px;
  }
  
  button {
    padding: 10px 16px;
    min-width: 80px;
    min-height: 42px;
    font-size: 0.9rem;
  }
  
  .player-avatar {
    width: 36px;
    height: 36px;
    font-size: 1.1rem;
  }
  
  .name {
    font-size: 0.8rem;
  }
  
  .score, .count {
    font-size: 0.7rem;
    padding: 3px 8px;
  }
  
  #info {
    font-size: 0.95rem;
    padding: 6px 12px;
  }
  
  .sound-toggles {
    gap: 4px;
  }
  
  .toggle-btn {
    width: 36px;
    height: 36px;
    font-size: 0.9rem;
  }
}

/* Small Mobile */
@media (max-width: 480px) {
  :root {
    --card-w: 50px;
    --card-h: 70px;
  }
  
  h1 {
    font-size: 1.1rem;
  }
  
  .panel {
    padding: 16px;
  }
  
  .panel h2 {
    font-size: 1.2rem;
  }
  
  .combo-grid {
    grid-template-columns: 1fr;
  }
}

/* Landscape mobile */
@media (max-height: 500px) and (orientation: landscape) {
  .table {
    grid-template-rows: auto 1fr auto;
  }
  
  #centerPanel {
    max-height: none;
    overflow: visible;
  }
  
  #logCenter {
    max-height: 60px;
  }
}

/* ====== Accessibility ====== */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  
  .bg-blob {
    animation: none;
  }
}

/* Focus styles */
button:focus-visible,
.card:focus-visible,
.chip:focus-visible {
  outline: 3px solid var(--coral);
  outline-offset: 2px;
}

/* High contrast mode */
@media (prefers-contrast: high) {
  .card {
    border-width: 4px;
  }
  
  button {
    border: 2px solid currentColor;
  }
}
</style>
</head>
<body>

<!-- Animated Background -->
<div class="bg-container">
  <div class="bg-blob"></div>
  <div class="bg-blob"></div>
  <div class="bg-blob"></div>
  <div class="bg-blob"></div>
</div>

<!-- Main Stage -->
<div id="stage">
  <div class="topbar">
    <h1>üê≠ Âêâ‰ºäÂç°ÂìáÂ§ßËÄÅ‰∫å üíï</h1>
    <div class="sound-toggles">
      <button id="sfxToggle" class="toggle-btn" title="Èü≥Êïà">üîä</button>
      <button id="bgmToggle" class="toggle-btn" title="Èü≥Ê®Ç">üéµ</button>
    </div>
  </div>
  
  <div class="table">
    <!-- Top Player -->
    <div id="p-top" class="player">
      <div class="player-avatar">üê∞</div>
      <div class="name" id="name-top"></div>
      <div class="player-info">
        <div class="score" id="score-top">10000 ÂàÜ</div>
        <div class="count" id="cnt-top">13</div>
      </div>
      <div class="hand" id="hand-top"></div>
    </div>
    
    <!-- Left Player -->
    <div id="p-left" class="player">
      <div class="player-avatar">üê±</div>
      <div class="name" id="name-left"></div>
      <div class="player-info">
        <div class="score" id="score-left">10000 ÂàÜ</div>
        <div class="count" id="cnt-left">13</div>
      </div>
      <div class="hand" id="hand-left"></div>
    </div>
    
    <!-- Center Panel -->
    <div id="centerPanel">
      <div id="fx"></div>
      
      <div id="centerTools">
        <div id="ctLeft" class="ct-side">
          <button id="resetScoreBtn" class="btn-ghost btn-small">üîÑ ÈáçÁΩÆÂàÜÊï∏</button>
        </div>
        <div id="ctRight" class="ct-side">
          <button id="autoBtn" class="btn-ghost btn-small">ü§ñ ‰ª£ÊâìÔºöÈóú</button>
        </div>
      </div>
      
      <div id="info">ËºâÂÖ•‰∏≠‚Ä¶</div>
      <div id="last"></div>
      
      <div id="pile"></div>
      
      <div id="logCenter"></div>
      
      <div class="actionRow">
        <button id="hintBtn" class="btn-ghost">üí° ÊèêÁ§∫</button>
        <button id="playBtn" disabled>‚ñ∂ Âá∫Áâå</button>
        <button id="passBtn" disabled>‚è≠ PASS</button>
        <button id="dealBtn" class="btn-ghost">üîÄ ÈáçÁôº</button>
      </div>
    </div>
    
    <!-- Right Player -->
    <div id="p-right" class="player">
      <div class="player-avatar">ü¶ä</div>
      <div class="name" id="name-right"></div>
      <div class="player-info">
        <div class="score" id="score-right">10000 ÂàÜ</div>
        <div class="count" id="cnt-right">13</div>
      </div>
      <div class="hand" id="hand-right"></div>
    </div>
    
    <!-- Bottom Player (You) -->
    <div id="p-bottom" class="player">
      <div class="player-avatar">üê≠</div>
      <div class="name" id="name-bottom">‰Ω†</div>
      <div class="player-info">
        <div class="score" id="score-bottom">10000 ÂàÜ</div>
        <div class="count" id="cnt-bottom">13</div>
      </div>
      <div class="hand" id="hand-bottom"></div>
    </div>
  </div>
</div>

<!-- Hint Overlay -->
<div id="hintOverlay" class="overlay">
  <div id="hintPanel" class="panel">
    <h2>üí° ÂèØÂá∫ÁµÑÂêà</h2>
    <div id="hintToolbar"></div>
    <div id="hintSections"></div>
    <div style="display:flex;justify-content:center;margin-top:16px">
      <button class="btn-ghost" onclick="closeHints()">ÈóúÈñâ</button>
    </div>
  </div>
</div>

<!-- Round Result Overlay -->
<div id="roundOverlay" class="overlay">
  <div class="panel">
    <h2 id="roundTitle">üéâ Êú¨Â±ÄÁµêÁÆó</h2>
    <ul id="roundList" class="pList"></ul>
    <div style="display:flex;gap:12px;justify-content:center;margin-top:16px">
      <button id="roundContinueBtn">ÁπºÁ∫å‰∏ã‰∏ÄÂ±Ä ‚ñ∂</button>
    </div>
  </div>
</div>

<!-- Series Result Overlay -->
<div id="seriesOverlay" class="overlay">
  <div class="panel">
    <h2>üèÜ Á≥ªÂàóÊà∞ÁµêÁÆó</h2>
    <p style="text-align:center;color:var(--text-secondary);margin-bottom:16px">ÊúâÁé©ÂÆ∂ÂàÜÊï∏Ê≠∏Èõ∂ÔºÅ</p>
    <ul id="rankList" class="rank"></ul>
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
      <button id="restartSeriesBtn">üîÑ ÈáçÊñ∞ÈñãÂßã</button>
      <button class="btn-ghost" id="closeSeriesBtn">ÈóúÈñâ</button>
    </div>
  </div>
</div>

<script>
"use strict";

/* ====== Sound Effects System (WebAudio) ====== */
const SFX = (() => {
  let enabled = true;
  let ctx, master;
  
  function ensure() {
    if (ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = 0.4;
    master.connect(ctx.destination);
  }
  
  function tone(freq = 440, dur = 0.18, type = 'sine', vol = 0.3) {
    if (!enabled) return;
    ensure();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(vol, ctx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
    o.connect(g);
    g.connect(master);
    o.start();
    o.stop(ctx.currentTime + dur);
  }
  
  function chord(freqs, dur = 0.3, vol = 0.18) {
    if (!enabled) return;
    ensure();
    freqs.forEach(f => tone(f, dur, 'sine', vol));
  }
  
  return {
    toggle() { enabled = !enabled; return enabled; },
    isEnabled() { return enabled; },
    click() { tone(880, 0.06, 'sine', 0.15); },
    play() { chord([523, 659, 784], 0.22, 0.18); },
    pass() { tone(220, 0.12, 'triangle', 0.2); },
    win() { chord([523, 659, 784, 1047], 0.4, 0.25); },
    playFor(kind, hasSpade2) {
      if (kind === 'ÂêåËä±È†Ü' || kind === 'ÈêµÊîØ') chord([659, 831, 988, 1175], 0.35, 0.28);
      else if (kind === 'Ëë´ËòÜ') chord([523, 659, 784], 0.28, 0.22);
      else if (kind === 'È†ÜÂ≠ê') chord([440, 554, 659], 0.22, 0.2);
      else if (kind === '‰∏âÊ¢ù') chord([392, 494, 587], 0.2, 0.18);
      else if (kind === 'Â∞çÂ≠ê') chord([349, 440], 0.18, 0.15);
      else chord([294, 370], 0.15, 0.12);
      if (hasSpade2) setTimeout(() => chord([1047, 1319, 1568], 0.3, 0.22), 120);
    }
  };
})();

/* ====== BGM System ====== */
const BGM = (() => {
  const PLAYLIST = ['BGM1.mp3', 'BGM2.mp3', 'BGM3.mp3', 'BGM4.mp3', 'BGM5.mp3'];
  let audio = null, idx = 0, enabled = true, armed = false, btn = null, tried = 0;

  function saved() {
    try { 
      const s = localStorage.getItem('big2_bgm'); 
      return s === null ? null : (s === '1'); 
    } catch(e) { return null; }
  }
  
  function save(v) { 
    try { localStorage.setItem('big2_bgm', v ? '1' : '0'); } catch(e) {} 
  }

  function init() {
    if (audio) return;
    audio = new Audio();
    audio.preload = 'auto';
    audio.volume = 0.15;
    audio.addEventListener('ended', next);
    audio.addEventListener('error', next);
  }
  
  function updateBtn() { 
    if (btn) {
      btn.textContent = enabled ? 'üéµ' : 'üéµ';
      btn.classList.toggle('off', !enabled);
    }
  }
  
  function start() {
    if (!enabled) return;
    init();
    if (!PLAYLIST.length) { enabled = false; updateBtn(); return; }
    audio.src = PLAYLIST[idx % PLAYLIST.length];
    audio.play().catch(() => {});
  }
  
  function next() {
    idx = (idx + 1) % PLAYLIST.length;
    tried++;
    if (tried >= PLAYLIST.length) { enabled = false; updateBtn(); return; }
    if (enabled) start();
  }
  
  function arm() {
    if (armed) return;
    armed = true;
    const once = () => { document.removeEventListener('pointerdown', once); start(); };
    document.addEventListener('pointerdown', once, { once: true });
  }
  
  return {
    toggle() { 
      enabled = !enabled; 
      tried = 0; 
      save(enabled); 
      updateBtn();
      if (enabled) start(); 
      else if (audio) audio.pause();
      return enabled;
    },
    mount(button) {
      btn = button;
      const s = saved();
      enabled = (s === null) ? false : s; // Default to off
      updateBtn();
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggle();
      }, { passive: true });
      arm();
    }
  };
})();

/* ====== Game Logic ====== */
const $ = s => document.querySelector(s);
const RANKS = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2'];
const SUITS = ['‚ô£', '‚ô¶', '‚ô•', '‚ô†'];
const NAMES = ['Â∞èÂÖ´', 'ÁÉèËñ©Â•á', 'Ê†óÂ≠êÈ•ÖÈ†≠', 'Â∞èÊ°É', 'ÁçÖËñ©', 'Â∏ïÊÅ∞', 'Êµ∑Áç∫', 'È£õÈº†', 'Âè§Êãâ', 'ÈéßÊ≠¶Â£´'];
const AVATARS = ['üê∞', 'üê±', 'ü¶ä', 'üêª', 'ü¶Å', 'üê∏', 'ü¶¶', 'üêøÔ∏è', 'ü¶î', 'ü§ñ'];

let deck = [];
let players = [[], [], [], []];
let scores = [10000, 10000, 10000, 10000];
let names = ['‰Ω†', '', '', ''];
let avatars = ['üê≠', 'üê∞', 'üê±', 'ü¶ä'];
let turn = 0;
let currentPlay = null;
let lastWinner = -1;
let firstTrick = true;
let pendingDeal = false;
let autoMy = false;

const logBox = $('#logCenter');

function randName() { return NAMES[Math.floor(Math.random() * NAMES.length)]; }
function randAvatar() { return AVATARS[Math.floor(Math.random() * AVATARS.length)]; }
function buildDeck() { deck = []; RANKS.forEach(r => SUITS.forEach(s => deck.push({ rank: r, suit: s }))); }
function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }
function rIdx(r) { return RANKS.indexOf(r); }
function sIdx(s) { return SUITS.indexOf(s); }
function compareCard(a, b) { const dr = rIdx(a.rank) - rIdx(b.rank); return dr !== 0 ? dr : sIdx(a.suit) - sIdx(b.suit); }
function findStart() { for (let i = 0; i < 4; i++) if (players[i].some(c => c.rank === '3' && c.suit === '‚ô£')) return i; return 0; }

function saveScores() { try { localStorage.setItem('big2_scores', JSON.stringify(scores)); } catch(e) {} }
function loadScores() { try { const s = localStorage.getItem('big2_scores'); if (s) { scores = JSON.parse(s); updateScoreUI(); } } catch(e) {} }

function updateScoreUI() {
  $('#score-bottom').textContent = scores[0] + ' ÂàÜ';
  $('#score-right').textContent = scores[1] + ' ÂàÜ';
  $('#score-top').textContent = scores[2] + ' ÂàÜ';
  $('#score-left').textContent = scores[3] + ' ÂàÜ';
}

function info(msg) { $('#info').textContent = msg; }
function setLast(msg) { $('#last').textContent = msg; }
function clearFX() { $('#fx').innerHTML = ''; $('#pile').classList.remove('highlight-pile'); }

function triggerFX(kind, cards) {
  clearFX();
  if (['ÂêåËä±È†Ü', 'ÈêµÊîØ', 'Ëë´ËòÜ'].includes(kind)) {
    const sym = document.createElement('div');
    sym.className = 'fx-symbol';
    sym.textContent = kind === 'ÂêåËä±È†Ü' ? 'üåü ÂêåËä±È†Ü' : kind === 'ÈêµÊîØ' ? 'üí• ÈêµÊîØ' : 'üéØ Ëë´ËòÜ';
    $('#fx').appendChild(sym);
    setTimeout(clearFX, 2000);
  }
  if (['ÂêåËä±È†Ü', 'ÈêµÊîØ', 'Ëë´ËòÜ', 'È†ÜÂ≠ê'].includes(kind)) {
    $('#pile').classList.add('highlight-pile');
  }
}

function logAppendText(txt) {
  const d = document.createElement('div');
  d.className = 'log-line';
  d.textContent = txt;
  logBox.appendChild(d);
  logBox.scrollTop = logBox.scrollHeight;
}

function logAppendPlay(who, cards, kind) {
  const line = document.createElement('div');
  line.className = 'log-line';
  
  const w = document.createElement('div');
  w.className = 'log-who';
  w.textContent = who;
  line.appendChild(w);
  
  const k = document.createElement('div');
  k.className = 'log-kind';
  k.textContent = kind;
  line.appendChild(k);
  
  const cs = document.createElement('div');
  cs.className = 'log-cards';
  cards.forEach(c => {
    const d = document.createElement('div');
    d.className = 'log-card ' + c.suit;
    d.textContent = c.suit + c.rank;
    cs.appendChild(d);
  });
  line.appendChild(cs);
  logBox.appendChild(line);
  logBox.scrollTop = logBox.scrollHeight;
}

function render() {
  const hb = $('#hand-bottom');
  hb.innerHTML = '';
  
  players[0].forEach((c, i) => {
    const d = document.createElement('div');
    d.className = 'card ' + c.suit;
    d.textContent = c.suit + c.rank;
    d.dataset.idx = i;
    d.tabIndex = 0;
    d.onclick = () => {
      if (turn !== 0 || autoMy) return;
      d.classList.toggle('selected');
      SFX.click();
    };
    d.onkeydown = (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        d.click();
      }
    };
    hb.appendChild(d);
  });
  
  if (players[0].length > 10) hb.classList.add('two-rows');
  else hb.classList.remove('two-rows');
  
  $('#cnt-bottom').textContent = players[0].length;
  $('#cnt-right').textContent = players[1].length;
  $('#cnt-top').textContent = players[2].length;
  $('#cnt-left').textContent = players[3].length;
  
  // Update active player indicators
  document.querySelectorAll('.player').forEach((p, i) => {
    const idx = ['p-bottom', 'p-right', 'p-top', 'p-left'].indexOf(p.id);
    if (idx !== -1) {
      p.classList.toggle('active', turn === idx);
    }
  });
}

function updateTurnUI() {
  const canAct = (turn === 0 && !autoMy);
  $('#playBtn').disabled = !canAct;
  $('#passBtn').disabled = !canAct;
  info(turn === 0 ? (autoMy ? `${names[0]}Ôºà‰ª£Êâì‰∏≠Ôºâ` : `Ëº™Âà∞‰Ω†Âá∫Áâå`) : `Ëº™Âà∞ ${names[turn]}`);
  
  // Update active states
  render();
}

/* ====== Card Analysis ====== */
function analyze(cards) {
  if (!cards || cards.length === 0) return { ok: false };
  const n = cards.length;
  
  if (n === 1) return { ok: true, kind: 'ÂñÆÂºµ', key: [rIdx(cards[0].rank), sIdx(cards[0].suit)] };
  
  if (n === 2) {
    if (cards[0].rank === cards[1].rank) {
      return { ok: true, kind: 'Â∞çÂ≠ê', key: [rIdx(cards[0].rank), Math.max(sIdx(cards[0].suit), sIdx(cards[1].suit))] };
    }
    return { ok: false };
  }
  
  if (n === 3) {
    if (cards[0].rank === cards[1].rank && cards[1].rank === cards[2].rank) {
      return { ok: true, kind: '‰∏âÊ¢ù', key: [rIdx(cards[0].rank), Math.max(sIdx(cards[0].suit), sIdx(cards[1].suit), sIdx(cards[2].suit))] };
    }
    return { ok: false };
  }
  
  if (n === 5) {
    const sorted = [...cards].sort(compareCard);
    const rc = {};
    sorted.forEach(c => rc[c.rank] = (rc[c.rank] || 0) + 1);
    const counts = Object.values(rc).sort((a, b) => b - a);
    const isFlush = sorted.every(c => c.suit === sorted[0].suit);
    const isStraight = sorted.every((c, i) => i === 0 || rIdx(c.rank) === rIdx(sorted[i - 1].rank) + 1);
    
    if (counts[0] === 4) {
      const quad = sorted.find(c => rc[c.rank] === 4);
      return { ok: true, kind: 'ÈêµÊîØ', key: [rIdx(quad.rank), sIdx(quad.suit)] };
    }
    if (counts[0] === 3 && counts[1] === 2) {
      const trip = sorted.find(c => rc[c.rank] === 3);
      return { ok: true, kind: 'Ëë´ËòÜ', key: [rIdx(trip.rank), Math.max(...sorted.filter(c => c.rank === trip.rank).map(c => sIdx(c.suit)))] };
    }
    if (isFlush && isStraight) return { ok: true, kind: 'ÂêåËä±È†Ü', key: [rIdx(sorted[4].rank), sIdx(sorted[4].suit)] };
    if (isStraight) return { ok: true, kind: 'È†ÜÂ≠ê', key: [rIdx(sorted[4].rank), sIdx(sorted[4].suit)] };
    if (isFlush) return { ok: true, kind: 'ÂêåËä±', key: [rIdx(sorted[4].rank), sIdx(sorted[4].suit)] };
    return { ok: false };
  }
  
  return { ok: false };
}

function canBeat(a, b) {
  const aa = analyze(a), bb = analyze(b);
  if (!aa.ok || !bb.ok) return false;
  if (aa.kind !== bb.kind) {
    const bombs = ['ÈêµÊîØ', 'ÂêåËä±È†Ü'];
    if (bombs.includes(aa.kind) && !bombs.includes(bb.kind)) return true;
    if (!bombs.includes(aa.kind) && bombs.includes(bb.kind)) return false;
    return false;
  }
  if (aa.key[0] !== bb.key[0]) return aa.key[0] > bb.key[0];
  return aa.key[1] > bb.key[1];
}

/* ====== Combo Generation ====== */
function combos(hand) {
  const res = [];
  const n = hand.length;
  
  for (let i = 0; i < n; i++) res.push([hand[i]]);
  for (let i = 0; i < n; i++) for (let j = i + 1; j < n; j++) res.push([hand[i], hand[j]]);
  for (let i = 0; i < n; i++) for (let j = i + 1; j < n; j++) for (let k = j + 1; k < n; k++) res.push([hand[i], hand[j], hand[k]]);
  for (let i = 0; i < n; i++) for (let j = i + 1; j < n; j++) for (let k = j + 1; k < n; k++) for (let l = k + 1; l < n; l++) for (let m = l + 1; m < n; m++) res.push([hand[i], hand[j], hand[k], hand[l], hand[m]]);
  
  return res.filter(c => analyze(c).ok);
}

/* ====== AI Logic ====== */
function pickLeaderCombo(all, enemyAlmostWin) {
  const prefer = enemyAlmostWin 
    ? ['ÂêåËä±È†Ü', 'ÈêµÊîØ', 'Ëë´ËòÜ', 'È†ÜÂ≠ê', '‰∏âÊ¢ù', 'Â∞çÂ≠ê', 'ÂñÆÂºµ']
    : ['È†ÜÂ≠ê', 'Ëë´ËòÜ', '‰∏âÊ¢ù', 'Â∞çÂ≠ê', 'ÂñÆÂºµ'];
  for (const k of prefer) {
    const cands = all.filter(c => analyze(c).kind === k);
    if (cands.length) return cands[0];
  }
  return all[0] || null;
}

function pickResponseCombo(options, currentPlay) {
  const needKind = analyze(currentPlay).kind;
  const same = options.filter(c => analyze(c).kind === needKind);
  if (same.length) return same[0];
  const bombs = options.filter(c => ['ÈêµÊîØ', 'ÂêåËä±È†Ü'].includes(analyze(c).kind));
  if (bombs.length) return bombs[0];
  return options[0] || null;
}

function aiMove(i) {
  const hand = players[i];
  const isLeader = !currentPlay || i === lastWinner;
  const all = combos(hand);
  const enemyAlmostWin = players.some((p, idx) => idx !== i && p.length <= 2);
  let options = [];
  
  if (!currentPlay) {
    options = firstTrick ? all.filter(c => c.some(x => x.rank === '3' && x.suit === '‚ô£')) : all;
    const choice = pickLeaderCombo(options, enemyAlmostWin);
    if (choice) play(i, choice);
    else { logAppendText(`${names[i]} PASS`); SFX.pass(); next(); }
    return;
  } else {
    options = all.filter(c => canBeat(c, currentPlay));
    if (options.length) {
      const choice = pickResponseCombo(options, currentPlay);
      play(i, choice);
      return;
    }
    if (isLeader) {
      const nonSingles = all.filter(c => analyze(c).kind !== 'ÂñÆÂºµ');
      play(i, (nonSingles[0] || all[0]));
    } else {
      logAppendText(`${names[i]} PASS`);
      SFX.pass();
      next();
    }
  }
}

/* ====== Play & Turn ====== */
function toStr(cards) { return cards.map(c => c.suit + c.rank).join(' '); }

function renderPile(playerName, cards, kind) {
  const pile = $('#pile');
  pile.innerHTML = '';
  
  const head = document.createElement('div');
  head.className = 'pile-header';
  head.textContent = `${playerName}Ôºà${kind}Ôºâ`;
  pile.appendChild(head);
  
  const row = document.createElement('div');
  row.className = 'pile-cards';
  cards.forEach(c => {
    const d = document.createElement('div');
    d.className = 'pile-card ' + c.suit;
    d.textContent = c.suit + c.rank;
    row.appendChild(d);
  });
  pile.appendChild(row);
}

function play(i, cards) {
  cards.forEach(sel => {
    const idx = players[i].findIndex(p => p.rank === sel.rank && p.suit === sel.suit);
    if (idx > -1) players[i].splice(idx, 1);
  });
  render();
  
  const an = analyze(cards);
  currentPlay = cards;
  lastWinner = i;
  firstTrick = false;
  
  setLast(`${names[i]}Ôºö${toStr(cards)}Ôºà${an.kind}Ôºâ`);
  logAppendPlay(names[i], cards, an.kind);
  renderPile(names[i], cards, an.kind);
  triggerFX(an.kind, cards);
  
  const includesSpade2 = cards.some(c => c.rank === '2' && c.suit === '‚ô†');
  SFX.playFor(an.kind, includesSpade2);
  
  if (players[i].length === 0) { endRound(i); return; }
  next();
}

function next() {
  turn = (turn + 1) % 4;
  if (players[turn].length === 0) turn = (turn + 1) % 4;
  if (turn === lastWinner) {
    currentPlay = null;
    setLast(`${names[turn]} ÈáçÊñ∞Âá∫Áâå`);
    $('#pile').innerHTML = '';
    clearFX();
  }
  updateTurnUI();
  if (turn !== 0 || (turn === 0 && autoMy)) setTimeout(() => aiMove(turn), 600);
}

function selected() {
  return [...document.querySelectorAll('#hand-bottom .card.selected')].map(el => players[0][parseInt(el.dataset.idx, 10)]);
}

function onPlay() {
  if (turn !== 0 || autoMy) return;
  const cs = selected();
  if (!cs.length) { info('Ë´ãÂÖàÈÅ∏Áâå'); return; }
  const an = analyze(cs);
  if (!an.ok) { info('‰∏çÂêàÊ≥ïÁµÑÂêà'); return; }
  if (firstTrick && !cs.some(c => c.rank === '3' && c.suit === '‚ô£')) { info('È¶ñÊîªÂøÖÂê´ ‚ô£3'); return; }
  if (currentPlay && !canBeat(cs, currentPlay)) { info('ÊØî‰∏çÈÅéÂâçÂÆ∂'); return; }
  play(0, cs);
}

function onPass() {
  if (turn !== 0 || autoMy) return;
  if (!currentPlay) { info('È¶ñÊîª‰∏çÂèØ PASS'); return; }
  info('‰Ω† PASS');
  logAppendText('‰Ω† PASS');
  SFX.pass();
  next();
}

/* ====== Scoring ====== */
function hasFourOfKind(hand) {
  const rc = {};
  hand.forEach(c => rc[c.rank] = (rc[c.rank] || 0) + 1);
  return Object.values(rc).some(v => v === 4);
}

function hasStraightFlush(hand) {
  const bySuit = { '‚ô£': [], '‚ô¶': [], '‚ô•': [], '‚ô†': [] };
  hand.forEach(c => bySuit[c.suit].push(c));
  for (const s in bySuit) {
    const arr = bySuit[s].sort(compareCard);
    for (let i = 0; i <= arr.length - 5; i++) {
      const slice = arr.slice(i, i + 5);
      if (slice.length === 5 && slice.every((c, idx) => idx === 0 || rIdx(c.rank) === rIdx(slice[idx - 1].rank) + 1)) return true;
    }
  }
  return false;
}

function endRound(winnerIdx) {
  const per = [];
  let totalGain = 0;
  
  for (let i = 0; i < 4; i++) {
    if (i === winnerIdx) continue;
    const remain = players[i];
    let base = remain.length * 10;
    let factor = 1;
    const why = [];
    why.push(`Ââ© ${remain.length} Âºµ √ó10 = ${base}`);
    if (remain.length >= 8) { factor *= 2; why.push('‚â•8 Âºµ √ó2'); }
    if (remain.some(c => c.rank === '2')) { factor *= 2; why.push('Âê´ 2 √ó2'); }
    if (hasFourOfKind(remain)) { factor *= 2; why.push('ÈêµÊîØ √ó2'); }
    if (hasStraightFlush(remain)) { factor *= 2; why.push('ÂêåËä±È†Ü √ó2'); }
    const pen = base * factor;
    scores[i] -= pen;
    totalGain += pen;
    per.push({ i, name: names[i], delta: -pen, explain: why.join('„ÄÅ'), after: scores[i] });
  }
  
  scores[winnerIdx] += totalGain;
  per.push({ i: winnerIdx, name: names[winnerIdx], delta: +totalGain, explain: `Ë¥èËµ∞ÂÖ∂‰ªñÁé©ÂÆ∂Êá≤ÁΩ∞Á∏ΩÂíå +${totalGain}`, after: scores[winnerIdx] });
  updateScoreUI();
  saveScores();
  
  SFX.win();
  showRound(per, winnerIdx);
  
  const zeroIdx = scores.findIndex(s => s <= 0);
  if (zeroIdx !== -1) { showSeries(); }
}

function showRound(per, winnerIdx) {
  const list = $('#roundList');
  list.innerHTML = '';
  $('#roundTitle').innerText = `üéâ ${names[winnerIdx]} ËÑ´ÊâãÁç≤ÂãùÔºÅ`;
  
  per.sort((a, b) => a.i - b.i).forEach(row => {
    const li = document.createElement('li');
    li.className = 'pItem';
    const left = document.createElement('div');
    left.innerHTML = `<div class="pName">${row.name}</div><div class="pExplain">${row.explain}</div>`;
    const right = document.createElement('div');
    right.className = 'pRight';
    const delta = document.createElement('div');
    delta.className = 'pDelta ' + (row.delta >= 0 ? 'plus' : 'minus');
    delta.textContent = (row.delta >= 0 ? '+' : '') + row.delta;
    const after = document.createElement('div');
    after.className = 'pScore';
    after.textContent = row.after + ' ÂàÜ';
    right.appendChild(delta);
    right.appendChild(after);
    li.appendChild(left);
    li.appendChild(right);
    list.appendChild(li);
  });
  
  document.getElementById('roundOverlay').style.display = 'flex';
  pendingDeal = true;
}

function showSeries() {
  const rank = scores.map((s, i) => ({ i, name: names[i], score: s })).sort((a, b) => b.score - a.score);
  const ul = $('#rankList');
  ul.innerHTML = '';
  
  const medals = ['ü•á', 'ü•à', 'ü•â', ''];
  rank.forEach((r, idx) => {
    const li = document.createElement('li');
    li.innerHTML = `<div>${medals[idx] || ''} ${r.name}</div><div>${r.score} ÂàÜ</div>`;
    ul.appendChild(li);
  });
  
  document.getElementById('seriesOverlay').style.display = 'flex';
}

document.getElementById('roundContinueBtn').onclick = () => {
  document.getElementById('roundOverlay').style.display = 'none';
  if (pendingDeal) { pendingDeal = false; deal(); }
};

document.getElementById('restartSeriesBtn').onclick = () => {
  scores = [10000, 10000, 10000, 10000];
  saveScores();
  updateScoreUI();
  document.getElementById('seriesOverlay').style.display = 'none';
  deal();
};

document.getElementById('closeSeriesBtn').onclick = () => {
  document.getElementById('seriesOverlay').style.display = 'none';
};

/* ====== Hints System ====== */
const HINT_TYPES = ['ÂñÆÂºµ', 'Â∞çÂ≠ê', '‰∏âÊ¢ù', 'È†ÜÂ≠ê', 'Ëë´ËòÜ', 'ÈêµÊîØ', 'ÂêåËä±È†Ü'];
const hintOverlay = $('#hintOverlay'), hintToolbar = $('#hintToolbar'), hintSections = $('#hintSections');
let hintOnlyBeat = true, hintNeedType = null;

function openHints() {
  hintNeedType = currentPlay ? analyze(currentPlay).kind : null;
  hintOnlyBeat = !!currentPlay;
  renderHint();
  hintOverlay.style.display = 'flex';
}

function closeHints() { hintOverlay.style.display = 'none'; }
hintOverlay.addEventListener('click', e => { if (e.target === hintOverlay) closeHints(); });

function makeChip(text, active, onClick) {
  const c = document.createElement('div');
  c.className = 'chip' + (active ? ' active' : '');
  c.textContent = text;
  c.onclick = onClick;
  c.tabIndex = 0;
  c.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onClick(); } };
  return c;
}

function renderHint() {
  hintToolbar.innerHTML = '';
  hintSections.innerHTML = '';
  
  hintToolbar.appendChild(makeChip(hintOnlyBeat ? '‚úì Âè™ÁúãÂèØÂ£ìÈÅé' : '‚óã Âè™ÁúãÂèØÂ£ìÈÅé', hintOnlyBeat, () => { hintOnlyBeat = !hintOnlyBeat; renderHint(); }));
  
  HINT_TYPES.forEach(t => {
    hintToolbar.appendChild(makeChip(t + (hintNeedType === t ? ' ‚úì' : ''), hintNeedType === t, () => { hintNeedType = (hintNeedType === t ? null : t); renderHint(); }));
  });
  
  let arr = combos(players[0]);
  if (firstTrick) arr = arr.filter(c => c.some(x => x.rank === '3' && x.suit === '‚ô£'));
  if (hintOnlyBeat && currentPlay) arr = arr.filter(c => canBeat(c, currentPlay));
  if (hintNeedType) arr = arr.filter(c => analyze(c).kind === hintNeedType);
  
  if (arr.length === 0) {
    hintSections.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px">ÔºàÁõÆÂâçÊ≤íÊúâÂèØÂá∫ÁöÑÁµÑÂêàÔºâ</p>';
    return;
  }
  
  const groups = {};
  arr.forEach(c => { const k = analyze(c).kind; (groups[k] = groups[k] || []).push(c); });
  
  HINT_TYPES.forEach(k => {
    if (!groups[k] || groups[k].length === 0) return;
    const sec = document.createElement('div');
    sec.className = 'section';
    const h4 = document.createElement('h4');
    h4.textContent = `${k}Ôºà${groups[k].length}Ôºâ`;
    sec.appendChild(h4);
    
    const grid = document.createElement('div');
    grid.className = 'combo-grid';
    
    groups[k].forEach(c => {
      const row = document.createElement('div');
      row.className = 'combo-row';
      row.tabIndex = 0;
      
      c.forEach(card => {
        const m = document.createElement('div');
        m.className = 'mini ' + card.suit;
        m.textContent = card.suit + card.rank;
        row.appendChild(m);
      });
      
      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.textContent = k;
      row.appendChild(tag);
      
      const selectCombo = () => {
        document.querySelectorAll('#hand-bottom .card').forEach(el => el.classList.remove('selected'));
        const hb = [...document.querySelectorAll('#hand-bottom .card')];
        const need = c.map(x => x.suit + x.rank);
        hb.forEach(el => {
          const key = el.textContent;
          const idx = need.indexOf(key);
          if (idx > -1) {
            el.classList.add('selected');
            need.splice(idx, 1);
          }
        });
        closeHints();
      };
      
      row.onclick = selectCombo;
      row.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectCombo(); } };
      
      grid.appendChild(row);
    });
    
    sec.appendChild(grid);
    hintSections.appendChild(sec);
  });
}

/* ====== Event Bindings ====== */
document.getElementById('playBtn').onclick = onPlay;
document.getElementById('passBtn').onclick = onPass;
document.getElementById('dealBtn').onclick = deal;
document.getElementById('hintBtn').onclick = openHints;
document.getElementById('resetScoreBtn').onclick = () => {
  scores = [10000, 10000, 10000, 10000];
  saveScores();
  updateScoreUI();
  logAppendText('üîÑ ÂàÜÊï∏Â∑≤ÈáçÁΩÆÁÇ∫ 10000');
};

document.getElementById('autoBtn').onclick = () => {
  autoMy = !autoMy;
  document.getElementById('autoBtn').textContent = `ü§ñ ‰ª£ÊâìÔºö${autoMy ? 'Èñã' : 'Èóú'}`;
  try { localStorage.setItem('big2_auto', autoMy ? '1' : '0'); } catch(e) {}
  updateTurnUI();
  if (autoMy && turn === 0) { setTimeout(() => aiMove(0), 450); }
};

document.getElementById('sfxToggle').onclick = () => {
  const enabled = SFX.toggle();
  document.getElementById('sfxToggle').textContent = enabled ? 'üîä' : 'üîá';
  document.getElementById('sfxToggle').classList.toggle('off', !enabled);
};

BGM.mount(document.getElementById('bgmToggle'));

/* ====== Wheel Scroll Helper ====== */
(function() {
  const hand = document.getElementById('hand-bottom');
  if (!hand) return;
  function wheelToScroll(e) {
    if (window.matchMedia('(min-width:1024px)').matches && Math.abs(e.deltaY) > 0) {
      hand.scrollLeft += e.deltaY;
      e.preventDefault();
    }
  }
  hand.addEventListener('wheel', wheelToScroll, { passive: false });
})();

/* ====== Keyboard Shortcuts ====== */
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  
  if (e.key === 'Enter' || e.key === ' ') {
    if (turn === 0 && !autoMy && document.activeElement === document.body) {
      e.preventDefault();
      onPlay();
    }
  } else if (e.key === 'Escape') {
    if (hintOverlay.style.display === 'flex') {
      closeHints();
    }
  } else if (e.key === 'p' || e.key === 'P') {
    if (turn === 0 && !autoMy) {
      onPass();
    }
  } else if (e.key === 'h' || e.key === 'H') {
    openHints();
  }
});

/* ====== Deal / Initialize ====== */
function deal() {
  names = ['‰Ω†', randName(), randName(), randName()];
  avatars = ['üê≠', randAvatar(), randAvatar(), randAvatar()];
  
  // Ensure unique names
  while (names[2] === names[1]) names[2] = randName();
  while (names[3] === names[1] || names[3] === names[2]) names[3] = randName();
  
  document.getElementById('name-right').innerText = names[1];
  document.getElementById('name-top').innerText = names[2];
  document.getElementById('name-left').innerText = names[3];
  
  // Update avatars
  document.querySelector('#p-right .player-avatar').textContent = avatars[1];
  document.querySelector('#p-top .player-avatar').textContent = avatars[2];
  document.querySelector('#p-left .player-avatar').textContent = avatars[3];
  
  document.getElementById('pile').innerHTML = '';
  logBox.innerHTML = '';
  setLast('');
  clearFX();
  
  buildDeck();
  shuffle(deck);
  
  players = [[], [], [], []];
  for (let i = 0; i < 52; i++) players[i % 4].push(deck[i]);
  players.forEach(p => p.sort(compareCard));
  
  currentPlay = null;
  lastWinner = -1;
  firstTrick = true;
  turn = findStart();
  
  render();
  updateTurnUI();
  info(`ÊåÅÊúâ ‚ô£3 ÁöÑÁé©ÂÆ∂Ôºà${names[turn]}ÔºâÂÖàÊîª`);
  
  if (turn !== 0) setTimeout(() => aiMove(turn), 600);
}

/* ====== Boot ====== */
(function boot() {
  loadScores();
  try {
    const savedAuto = localStorage.getItem('big2_auto');
    if (savedAuto === '1') {
      autoMy = true;
      document.getElementById('autoBtn').textContent = 'ü§ñ ‰ª£ÊâìÔºöÈñã';
    }
  } catch(e) {}
  deal();
})();
</script>
</body>
</html>
